{% extends "layout.html" %}

{% block content %}

	{% if user.is_authenticated %}
        <div class="controlbox" id="admin">
            <a id="new" href="{% url 'question_new' %}">Create a new question</a>
            <form action="{% url 'question_upload' %}" method="post" id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <a href="" id="upload">Upload a question</a>
                <div class="upload">
                    <input type="file" name="file" value="yo"/>
                </div>
            </form>
        </div>
	{% endif %}

    <div class="row-fluid">
        <form class="searchBox form-inline" data-bind="with: search, submit: search.submit">
			<label for="search_query">
				Search for questions called:
				<div class="input-append">
					<input role="search" id="search_query" type="text" name="questionSearch" data-bind="value: query, valueUpdate: 'afterkeydown'"/>
					<span class="add-on"><button type="submit" class="search" data-bind="css: {loading: searching}"></button></span>
				</div>
			</label>
			<label for="search_author">
				by author: 	
				<input id="search_author" type="text" size="30" data-bind="
					value: author,
					valueUpdate: 'afterkeydown',
					autocomplete: '{% url 'user_search' %}', 
					autocompleteCallback: function(user) { return {label: user.username+' ('+user.name+')', value: user.username} },
					click: clearMine
				"/>
			</label>
			{% if user.is_authenticated %}<label class="checkbox"><input type="checkbox" data-bind="checked: mine"/> Mine only.</label>{% endif %}
			<label for="search_progress">
				Filter by progress:
				<select data-bind="value: progress">
					<option selected></option>
					{% for code,text in progresses %}
					<option value="{{code}}">{{text}}</option>
					{% endfor %}
				</select>
			</label>
		</form>
	</div>

	<div data-bind="with: search.results">
		<div class="pagination" data-bind="visible: pages().length>0">
			Page:
			<button type="button" class="move previous" data-bind="click: prevPage"></button><span class="pagenumber" data-bind="text: pageText"></span><button type="button" class="move next" data-bind="click: nextPage"></button>
		</div>
		<div class="results">
			<table class="search-results" id="question-list" data-bind="visible: all().length>0">
				<col span="1" class="name"/>
				<col span="1" class="author"/>
				<col span="1" class="col-progress"/>
				<col span="1" class="last_modified"/>
				<col span="1" class="admin"/>
                <thead data-bind="with: $root.search">
                    <th data-bind="css: {sorted: orderBy()=='name', descending: descending}, click: setOrder('name')">Name</th>
                    <th data-bind="css: {sorted: orderBy()=='author', descending: descending}, click: setOrder('author')">Author</th>
                    <th data-bind="css: {sorted: orderBy()=='progress', descending: descending}, click: setOrder('progress')">Progress</th>
					<th data-bind="css: {sorted: orderBy()=='last_modified', descending: descending}, click: setOrder('last_modified',true)">Last Modified</th>
				</thead>
				<tbody class="results editlist big" data-bind="foreach: {
					data: pages()[page()-1]
				}">
					<tr class="result question">
						<td>
							<a data-bind="attr: {href: url}, text: name"></a>
							<div class="description" data-bind="visible: metadata.description.length>0, html: $(metadata.description).text(), mathjax: true"></div>
						</td>
                        <td><span data-bind="text: author"></span></td>
                        <td><span data-bind="text: progressDisplay, attr: {'class': 'progress-display '+progress}"></span></td>
						<td><span data-bind="calendarTime: last_modified"></span></td>
						<td class="admin">
							<a class="preview" data-bind="attr: {href: url+'preview/'}" target="_blank" title="Test run"></a>
							{% if user.is_authenticated %}
							<a class="copy" data-bind="attr: {href: url+'copy/'}" title="Make a copy"></a>
							{% endif %}
							<a class="delete" data-bind="visible: canEdit, attr: {href: url+'delete/'}, click: function() {$parent.deleteQuestion(this) }" title="Delete"></a>
						</td>
					</tr>
				</tbody>
			</table>
			<div class="none" data-bind="visible: all().length==0, text: $parent.searching() ? 'Loading results...' : 'No questions found.'" ></div>
			<div class="error" data-bind="visible: error().length>0, html: error"></div>
		</div>
		<div class="pagination" data-bind="visible: pages().length>0">
			Page:
			<button type="button" class="move previous" data-bind="click: prevPage"></button><span class="pagenumber" data-bind="text: pageText"></span><button type="button" class="move next" data-bind="click: nextPage"></button>
		</div>
	</div>
    
    <script type="text/html" id="question">
    </script>

{% endblock content %}

{% block javascripts %}
    {{block.super}}
    <script type="text/javascript" src="{{ STATIC_URL }}js/question/index.js"></script>
{% endblock javascripts %}

{% block stylesheets %}
	{{ block.super }}
    <link href="{{ STATIC_URL }}css/index.css" type="text/css" rel="stylesheet" />
    <link href="{{ STATIC_URL }}css/question/index.css" type="text/css" rel="stylesheet" />
{% endblock stylesheets %}
