{% extends "layout.html" %}

{% block content %}
{% if question_list %}
    <ul>
    {% for question in question_list %}
		<li class="question">
			<a href="{% url question_edit question.pk question.slug %}">{{ question.name }}</a>
			<a class="delete" href="{% url question_delete question.pk question.slug %}"></a>
		</li>
    {% endfor %}
    </ul>
{% else %}
    <p>No questions are available.</p>
{% endif %}
<a id="newQuestion" href="{% url question_new %}">New question</a>
<form action="{% url question_new %}" method="post" id="newQuestionForm">
	{% csrf_token %}
	Name: <input type="text" name="name" maxlength="200" />
	<input type="submit" value="Create" />
</form>
<form action="{% url question_upload %}" method="post" id="uploadQuestionForm">
	{% csrf_token %}
	Upload a question
	<div class="upload">
		<input type="file"/>
		<textarea name="content"></textarea>
	</div>
</form>
{% endblock content %}

{% block javascripts %}
	{{block.super}}
	<script language="javascript" type="text/javascript">
		$(document).ready(function() {
			$('a#newQuestion').click(function(e) {
				e.preventDefault();
				e.stopPropagation();

				$('a#newQuestion').hide();
				$('#newQuestionForm')
					.show()
					.css('display','inline-block')
					.find('input[name="name"]')
						.focus()
				;
			});

			function cancelCreate() {
				$('a#newQuestion').show();
				$('#newQuestionForm').hide();
			}

			$('#newQuestionForm')
				.hide()
				.submit(function(e) {
					var name = $(this).find('input[name="name"]').val();
					if(!name.trim().length)
					{
						e.preventDefault();
						e.stopPropagation();
					}
				})
				.find('input[name="name"]')
					.keyup(function(e) {
						if(e.which==27)
							cancelCreate();
					})
			;

			$('.question .delete').on('click',function(e) {
				e.stopPropagation();
				e.preventDefault();
				if(window.confirm('Delete this question?')) {
					var url = $(this).attr('href');
					var item = $(this).parents('.question');
					$.post(url,{csrfmiddlewaretoken: getCookie('csrftoken')})
						.success(function() {
							item.slideUp(200,function() {item.remove()})
						})
						.error(function(response) {
							noty({text: 'Error deleting question:\n\n'+response.responseText, layout: 'center', type: 'error'});
						})
					;
				}
			});

			$.event.props.push('dataTransfer');
			$('#uploadQuestionForm').on({
				dragenter: function(e) {
					e.stopPropagation();
					e.preventDefault();
					$(this).addClass('over')
				},
				dragover: function(e) {
					e.stopPropagation();
					e.preventDefault();
				},
				dragleave: function(e) {
					$(this).removeClass('over');
				},
				drop: function(e) {
					$(this).removeClass('over');
					var file = e.dataTransfer.files[0];
					var fr = new FileReader();
					var form = $(this);
					var contentInput = $(this).find('[name=content]')
					fr.onload = function(e) {
						var content = e.target.result;
						contentInput.text(content);
						console.log(content);
						form.submit();
					}
					fr.readAsText(file);
				}
			});
		});
	</script>
{% endblock javascripts %}

{% block stylesheets %}
	{{ block.super }}
    <link href="{{ STATIC_URL }}css/index.css" type="text/css" rel="stylesheet" />
{% endblock stylesheets %}
