{% extends "question/edit.html" %}

{% block editable_message %}You can edit this question.{% endblock %}

{% block progress %}
<form class="form-inline">
	<label>
		Progress:
		<select data-bind="options: Editor.progresses, optionsText: '1', value: progress">
		</select>
	</label>
</form>
{% endblock progress %}

{% block editor %}
	{% include "editable.html" %}
	<div class="tab-content">
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='general'}">
			<div class="row-fluid">
				<div class="span9">
					<label>
						<h4>Question Name</h4>
						<input class="input-block-level" id="question-name" data-bind="value: name, valueUpdate: 'afterkeydown'" type="text"/>
					</label>
				</div>
			</div>
			<div class="row-fluid">
				<div class="span6">
					<label for="description"><h4>Description</h4></label>
					<div id="description" data-bind="writemaths: description"></div>
				</div>
				<div class="span6">
					<label for="authors-notes"><h4>Author's Notes</h4></label>
					<div id="authors-notes" data-bind="writemaths: notes"></div>
				</div>
			</div>
			<div class="row-fluid">
				<div class="span6">
					<h4>Extensions</h4>
					<ul class="extensions" data-bind="foreach: extensions">
						<li class="extension">
							<label>
								<input type="checkbox" data-bind="checked: used">
								<span data-bind="text:name"></span> <a data-bind="attr: {href:url}" target="_blank">(documentation)</a>
							</label>
						</li>
					</ul>
				</div>
				<div class="span6 tags">
					<h4>Tags</h4>
					<form data-bind="submit: function(form) {var input = $(form).find('input');$data.tags.push(input.val());input.val('').focus();}">
						<input type="text"></input>
					</form>
					<ul class="tags" data-bind="foreach: tags">
						<li class="tag well">
                        <a data-bind="attr: {href: '{% url 'question_search' %}?tags='+encodeURIComponent($data)}, text: $data"></a>
							<button type="button" class="delete" data-bind="click: $root.tags.remove" title="Remove this tag"></button>
						</li>
					</ul>
				</div>
			</div>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='statement'}">
			<div id="statement" data-bind="writemaths: statement"></div>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='variables'}">
			<div class="row-fluid">
				<div data-bind="sortable: {
							template: 'variable-template',
							data: variables,
							options: {handle: '.handle'}
						}">
				</div>
				<script type="text/html" id="variable-template">
					<div class="row-fluid insertvariable">
						<button title="Insert a new variable here" class="addvariable" data-bind="click: $parent.addVariableBefore"></button>
					</div>
					<div class="row-fluid variable">
						<div class="span1"><span class="handle"></span></div>
						<div class="span8">
							<form>
								<button type="button" title="Remove this variable" class="delete" data-bind="click:remove"></button>
								<input type="text" placeholder="Name" class="name" data-bind="value:name, valueUpdate: 'afterkeydown', attr: {disabled: !$parent.isadvanced()}, autosize: name"/>
								<span class="name-error" data-bind="text: nameError, visible: nameError"></span>
								<label class="control-label">Definition</label>
								<textarea class="def" data-bind="valueUpdate: 'afterkeydown', codemirror: definition, codemirrorMode: 'jme'"></textarea>
							</form>
						</div>
						<div class="span3">
							<div class="value" data-bind="css: {error: error().length>0}, html: display, mathjax: display"></div>
						</div>
					</div>
				</script>

				<div class="row-fluid">
					<div class="span5">
						<button type="button" data-bind="click:addVariable, text: variables().length ? 'Add another variable' : 'Add a variable'"></button>
						Automatically recalculate variables: <input type="checkbox" data-bind="checked: autoCalculateVariables"/>
					</div>
					<div class="span3 offset4">
						<button type="button" data-bind="click: computeVariables, visible: variables().length>0">Regenerate values</button>
					</div>
				</div>
			</div>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='functions'}">
			<div id="functions">
				<h4>Functions</h4>
				<!-- ko foreach: {data: functions, afterAdd: Editor.afterAdd, beforeRemove: Editor.beforeRemove} -->
				<div class="function row-fluid">
					<div class="span1">
						<button type="button" class="delete" data-bind="click:remove" title="Delete this function"></button>
					</div>
					<div class="span8">
						<div class="row-fluid">
							<div class="span4">
								<label>
									Name
									<div>
										<input placeholder="Name" type="text" data-bind="value: name, valueUpdate: 'afterkeydown', autosize: {value: name, max: 220}">
									</div>
								</label>
							</div>
							<div class="span4">
								<label>
									Language
									<select data-bind="options: languages, value: language"></select>
								</label>
							</div>
							<div class="span4">
								<label>
									Output type
									<select data-bind="options: types, value:type"></select>
								</label>
							</div>
							<div>
								<label>
									Definition:
									<textarea data-bind="codemirror: definition, codemirrorMode: language, valueUpdate: 'afterkeydown'"></textarea>
								</label>
								<div class="error" data-bind="visible: error().length>0">
									Error: <span class="errortext" data-bind="html: error"></span>
								</div>
							</div>
						</div>
					</div>
					<div class="span3">
						<label>Parameters</label>
						<!-- ko foreach: {data: parameters, afterAdd: Editor.afterAdd, beforeRemove: Editor.beforeRemove} -->
						<div class="row-fluid parameter">
							<form class="form-inline">
								<input class="name" type="text" placeholder="Name" data-bind="value: name"/>
								<select class="type" data-bind="options: $parent.types, value: type"></select>
								<button type="button" class="delete" data-bind="click: remove" title="Remove this parameter"></button>
							</form>
						</div>
						<!-- /ko -->
						<button type="button" class="addparameter" data-bind="click:addParameter, text: parameters().length ? 'Add another parameter' : 'Add a parameter'"></button>
					</div>
				</div>
				<!-- /ko -->
				<button type="button" data-bind="click:addFunction, text: functions().length ? 'Add another function' : 'Add a function'"></button>
			</div>
			<div id="rulesets">
				<h4>Rulesets</h4>
				<form class="form-horizontal">
					<!-- ko foreach: {data: rulesets, afterAdd: Editor.afterAdd, beforeRemove: Editor.beforeRemove} -->
						<div class="ruleset control-group">
							<span class="control-label">
								<input type="text" placeholder="Name" class="name control-label" data-bind="value:name, valueUpdate: 'afterkeydown'"/>
							</span>
							<div class="controls">:
								<div class="rules" data-bind="listbox:sets, rulesetcomplete: allsets"></div>
								<button type="button" class="delete" data-bind="click:remove" title="Delete this ruleset"></button>
							</div>
						</div>
					<!-- /ko -->
					<button type="button" data-bind="click:addRuleset, text: rulesets().length ? 'Add another ruleset' : 'Add a ruleset'"></button>
				</form>
			</div>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='parts'}">
			<div class="row-fluid">
				<div class="span3">
					<ol class="parts nav nav-list" data-bind="visible: parts().length>0, foreach: {data: parts, afterAdd: Editor.afterAdd, beforeRemove: Editor.beforeRemove}">
						<li class="part clearfix" data-bind="css: {active: $root.currentPart()==$data}">
							<div class="reorder" data-bind="visible: $root.currentPart()==$data && parentList().length>1">
								<button type="button" class="up" data-bind="click: moveUp"></button>
								<br/>
								<button type="button" class="down" data-bind="click: moveDown"></button>
							</div>
							<button type="button" class="delete" data-bind="click: remove" title="Delete this part"></button><a data-bind="text: header, click: $root.showPart" href="#"></a>
							<div class="subparts" data-bind="fadeVisible: meOrChildSelected">
								<div class="gaps" data-bind="if: type().name=='gapfill'">
									<h6>Gaps</h6>
									<ol class="gaps nav nav-list" data-bind="foreach: {data: gapfill.gaps, afterAdd: Editor.afterAdd, beforeRemove: Editor.beforeRemove}">
										<li class="part clearfix" data-bind="css: {active: $root.currentPart()==$data}">
											<div class="reorder" data-bind="visible: $root.currentPart()==$data && parentList().length>1">
												<button type="button" class="up" data-bind="click: moveUp"></button>
												<br/>
												<button type="button" class="down" data-bind="click: moveDown"></button>
											</div>
											<button type="button" class="delete" data-bind="click: remove" title="Delete this gap"></button><a data-bind="text: header, click: $root.showPart" href="#"></a>
										</li>
									</ol>
									<div class="addgap"><button type="button" data-bind="visible: $root.isadvanced, click:addGap, text: gapfill.gaps().length ? 'Add another gap' : 'Add a gap'"></button></div>
								</div>
								<div class="steps clearfix">
									<h6>Steps</h6>
									<ol class="steps nav nav-list" data-bind="foreach: {data: steps, afterAdd: Editor.afterAdd, beforeRemove: Editor.beforeRemove}">
										<li class="part clearfix" data-bind="css: {active: $root.currentPart()==$data}">
										<div class="reorder" data-bind="visible: $root.currentPart()==$data && parentList().length>1">
												<button type="button" class="up" data-bind="click: moveUp"></button>
												<br/>
												<button type="button" class="down" data-bind="click: moveDown"></button>
											</div>
											<button type="button" class="delete" data-bind="click: remove" title="Delete this step"></button><a data-bind="text: header, click: $root.showPart" href="#"></a>
										</li>
									</ol>
									<div class="addstep"><button type="button" data-bind="visible: $root.isadvanced, click:addStep, text: steps().length ? 'Add another step' : 'Add a step'"></button></div>
								</div>
							</div>
						</li>
					</ol>
					<button type="button" data-bind="visible: $root.isadvanced, click:addPart, text: parts().length ? 'Add another part' : 'Add a part'"></button>
				</div>
				<div class="span9 part-edit" data-bind="with: currentPart">
					<h4 class="header">
                        Type: <select class="type" data-bind="options: availableTypes, value:type, optionsText: 'niceName'"></select>
					</h4>
					<div class="row-fluid">
						<ul class="nav nav-tabs" data-bind="foreach: tabs">
							<li data-bind="css: {active: ko.utils.unwrapObservable($parent.currentTab().id) == $data.id}">
								<a href="#" data-bind="click: $parent.currentTab, text: title"></a>
							</li>
						</ul>
					</div>
					<div class="row-fluid">
						<div class="tab-content">
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='prompt'}">
								<div data-bind="writemaths: prompt"></div>
							</section>
							<!-- ko if: type().name=='gapfill' -->
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='marking'}">
								<form class="form-horizontal">
									<div class="control-group" data-bind="visible: !parent, template: {
										name: 'property',
										data: {label:'Penalty for revealing steps',property:stepsPenalty,min:0}
									}"></div>
								</form>
							</section>
							<!-- /ko -->
							<!-- ko if: type().name=='jme' -->
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='marking'}">
								<form class="form-horizontal">
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Marks',property:marks,min:0}
									}"></div>
									<div class="control-group" data-bind="visible: !parent, template: {
										name: 'property',
										data: {label:'Penalty for revealing steps',property:stepsPenalty,min:0}
									}"></div>
									<div class="control-group">
										<label>
											<span class="control-label">Correct answer</span>
											<div class="controls">
												<input class="monospace" type="text" data-bind="value: jme.answer, valueUpdate: 'input', autosize: {max: 500, min: 30, padding: 10, value: jme.answer}"/>
												<span data-bind="JME: jme.answer" class="jme-answer"></span>
											</div>
										</label>
									</div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Answer simplification rules',property:jme.answerSimplification, monospace: true}
									}"></div>
								</form>
							</section>
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='restrictions'}">
								<form class="form-horizontal">
									<h4>Checking accuracy</h4>
									<div class="control-group">
										<label>
											<span class="control-label">Checking type</span>
											<div class="controls">
												<select data-bind="options: jme.checkingTypes, value: jme.checkingType, optionsText:'niceName'"></select>
											</div>
										</label>
									</div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Checking accuracy',property:jme.checkingType().accuracy,min:0}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Points to check',property:jme.vset.points,min:0}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Maximum no. of failures',property:jme.failureRate,min:0, max:jme.vset.points}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Checking range start',property:jme.vset.start,max:jme.vset.end}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Checking range end',property:jme.vset.end,min:jme.vset.start}
									}"></div>
								</form>
								<h4>Length restriction</h4>
								<form class="form-horizontal">
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Maximum length',property:jme.maxlength.length,min:0}
									}"></div>
									<div data-bind="fadeVisible: jme.maxlength.length()>0">
										<div class="control-group" data-bind="template: {
											name:'percentproperty',
											data: {label:'Partial credit for long answer',property:jme.maxlength.partialCredit}
										}"></div>
										<div class="control-group">
											<label>
												<span class="control-label">Warning message</span>
												<div class="controls" data-bind="writemaths: jme.maxlength.message"></div>
											</label>
										</div>
									</div>
								</form>
								<form class="form-horizontal">
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Minimum length',property:jme.minlength.length,min:0}
									}"></div>
									<div data-bind="fadeVisible: jme.minlength.length()>0">
										<div class="control-group" data-bind="template: {
											name:'percentproperty',
											data: {label:'Partial credit for short answer',property:jme.minlength.partialCredit}
										}"></div>
										<div class="control-group">
											<label>
												<span class="control-label">Warning message</span>
												<div class="controls" data-bind="writemaths: jme.minlength.message"></div>
											</label>
										</div>
									</div>
								</form>
								<h4>String restriction</h4>
								<form class="form-horizontal">
									<div class="control-group">
										<label>
											<span class="control-label">Required strings:</span>
											<div class="controls" data-bind="listbox:jme.musthave.strings"></div>
										</label>
									</div>
									<div data-bind="fadeVisible: jme.musthave.strings().length>0">
										<div class="control-group" data-bind="template: {
											name:'percentproperty',
											data: {label:'Partial credit for not using all required strings:',property:jme.musthave.partialCredit}
										}"></div>
										<div class="control-group" data-bind="template: {
											name: 'booleanproperty',
											data: {label:'Show required strings in warning?', property:jme.musthave.showStrings}
										}"></div>
										<div class="control-group">
											<label>
												<span class="control-label">Warning message</span>
												<div class="controls" data-bind="writemaths: jme.musthave.message"></div>
											</label>
										</div>
									</div>
								</form>

								<form class="form-horizontal">
									<div class="control-group">
										<label>
											<span class="control-label">Forbidden strings:</span>
											<div class="controls" data-bind="listbox:jme.notallowed.strings"></div>
										</label>
									</div>
									<div data-bind="fadeVisible: jme.notallowed.strings().length>0">
										<div class="control-group" data-bind="template: {
											name:'percentproperty',
											data: {label:'Partial credit for not using all required strings:',property:jme.notallowed.partialCredit}
										}"></div>
										<div class="control-group" data-bind="template: {
											name: 'booleanproperty',
											data: {label:'Show required strings in warning?', property:jme.notallowed.showStrings}
										}"></div>
										<div class="control-group">
											<label>
												<span class="control-label">Warning message</span>
												<div class="controls" data-bind="writemaths: jme.notallowed.message"></div>
											</label>
										</div>
									</div>
								</form>
							</section>
							<!-- /ko -->
							<!-- ko if: type().name=='numberentry' -->
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='marking'}">
								<form class="form-horizontal">
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Marks',property:marks,min:0}
									}"></div>
									<div class="control-group" data-bind="visible: !parent, template: {
										name: 'property',
										data: {label:'Penalty for revealing steps',property:stepsPenalty,min:0}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Minimum accepted value',property:numberentry.minValue}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Maximum accepted value',property:numberentry.maxValue}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'booleanproperty',
										data: {label:'Must the answer be an integer?', property:numberentry.integerAnswer}
									}"></div>
									<div class="control-group" data-bind="fadeVisible: numberentry.integerAnswer,
									template: {
										name:'percentproperty',
										data: {label:'Partial credit for non-integer answer',property:numberentry.integerPartialCredit}
									}"></div>
									<div class="control-group">
										<label>
											<span class="control-label">Precision restriction</span>
											<div class="controls">
												<select data-bind="options: numberentry.precisionTypes, value: numberentry.precisionType, optionsText: 'niceName'"></select>
											</div>
										</label>
									</div>
									<div class="control-group" data-bind="fadeVisible: numberentry.precisionType().name!='none',
									template: {
										name:'property',
										data: {label:numberentry.precisionWord,property:numberentry.precision}
									}"></div>
									<div class="control-group" data-bind="fadeVisible: numberentry.precisionType().name!='none',
									template: {
										name:'percentproperty',
										data: {label:'Partial credit for wrong precision',property:numberentry.precisionPartialCredit}
									}"></div>
									<div class="control-group" data-bind="fadeVisible: numberentry.precisionType().name!='none'">
										<label>
											<span class="control-label">Message if wrong precision</span>
											<div class="controls" data-bind="writemaths: numberentry.precisionMessage"></div>
										</label>
									</div>
								</form>
							</section>
							<!-- /ko -->
							<!-- ko if: type().name=='patternmatch' -->
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='marking'}">
								<form class="form-horizontal">
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Marks',property:marks,min:0}
									}"></div>
									<div class="control-group" data-bind="visible: !parent, template: {
										name: 'property',
										data: {label:'Penalty for revealing steps',property:stepsPenalty,min:0}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Answer pattern',property:patternmatch.answer, monospace: true}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Display answer',property:patternmatch.displayAnswer}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'booleanproperty',
										data: {label:'Must the answer be in the correct case?', property:patternmatch.caseSensitive}
									}"></div>
									<div class="control-group" data-bind="
									fadeVisible:patternmatch.caseSensitive,
									template: {
										name:'percentproperty',
										data: {label:'Partial credit for answer not matching case',property:patternmatch.partialCredit}
									}"></div>
								</form>
							</section>
							<!-- /ko -->
							<!-- ko if: type().name=='1_n_2' -->
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='marking'}">
								<form class="form-horizontal">
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Minimum marks',property:multiplechoice.minMarks, max:multiplechoice.maxMarks }
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Maximum marks',property:multiplechoice.maxMarks, min:multiplechoice.minMarks}
									}"></div>
									<div class="control-group" data-bind="visible: !parent, template: {
										name: 'property',
										data: {label:'Penalty for revealing steps',property:stepsPenalty,min:0}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'booleanproperty',
										data: {label:'Shuffle order of choices?', property:multiplechoice.shuffleChoices}
									}"></div>
									<div class="control-group" data-bind="fadeVisible: multiplechoice.displayType().name!='dropdown',
									template: {
										name: 'property',
										data: {label:'Number of display columns',property:multiplechoice.displayColumns}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'booleanproperty',
										data: {label: 'Custom marking matrix?', property: multiplechoice.customMarking}
									}"></div>
									<div class="control-group" data-bind="fadeVisible: multiplechoice.customMarking, template: {
										name: 'property',
										data: {label: 'Custom matrix expression', property: multiplechoice.customMatrix}
									}"></div>
								</form>
							</section>
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='choices'}">
								<ul class="choices">
									<!-- ko foreach: {data: multiplechoice.choices, beforeRemove: Editor.beforeRemove, afterAdd: Editor.afterAdd} -->
									<li class="choice">
										<form class="form-inline">
											<button type="button" type="button" class="delete" data-bind="click:remove" title="Delete this choice"></button>
											<label>
												Marks:
												<input class="marks" type="text" data-bind="value:marks, valueUpdate:'input', autosize: {max: 500, min: 30, padding: 10, value: marks}"/>
											</label>
											<label>
												Distractor Message:
												<input type="text" data-bind="value:distractor, valueUpdate:'input', autosize: {max: 500, min: 100, padding: 10, value: distractor}"/>
											</label>
											<div id="description" data-bind="writemaths: content, wmHeight: 100, wmWidth: 500"></div>
										</form>
									</li>
									<!-- /ko -->
									<li><button type="button" data-bind="visible: $root.isadvanced, click:addChoice">Add a choice</button></li>
								</ul>
							</section>
							<!-- /ko -->
							<!-- ko if: type().name=='m_n_2' -->
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='marking'}">
								<form class="form-horizontal">
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Minimum marks',property:multiplechoice.minMarks, max:multiplechoice.maxMarks }
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Maximum marks',property:multiplechoice.maxMarks, min:multiplechoice.minMarks}
									}"></div>
									<div class="control-group" data-bind="visible: !parent, template: {
										name: 'property',
										data: {label:'Penalty for revealing steps',property:stepsPenalty,min:0}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Minimum answers:',property:multiplechoice.minAnswers, max:multiplechoice.maxAnswers}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Maximum answers:',property:multiplechoice.maxAnswers, min:multiplechoice.minAnswers}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'booleanproperty',
										data: {label:'Shuffle order of choices?', property:multiplechoice.shuffleChoices}
									}"></div>
									<div class="control-group" data-bind="fadeVisible: multiplechoice.displayType().name!='dropdown',
									template: {
										name: 'property',
										data: {label:'Number of display columns',property:multiplechoice.displayColumns}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'booleanproperty',
										data: {label: 'Custom marking matrix?', property: multiplechoice.customMarking}
									}"></div>
									<div class="control-group" data-bind="fadeVisible: multiplechoice.customMarking, template: {
										name: 'property',
										data: {label: 'Custom matrix expression', property: multiplechoice.customMatrix}
									}"></div>
								</form>
							</section>
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='choices'}">
								<ul class="choices">
									<!-- ko foreach: {data: multiplechoice.choices, beforeRemove: Editor.beforeRemove, afterAdd: Editor.afterAdd} -->
									<li class="choice">
										<form class="form-inline">
											<button type="button" class="delete" data-bind="click:remove" title="Delete this choice"></button>
											<label>
												Marks:
												<input class="marks" type="text" data-bind="value:marks, valueUpdate:'input', autosize: {max: 500, min: 30, padding: 10, value: marks}"/>
											</label>
											<label>
												Distractor Message:
												<input type="text" data-bind="value:distractor, valueUpdate:'input', autosize: {max: 500, min: 100, padding: 10, value: distractor}"/>
											</label>
											<div id="description" data-bind="writemaths: content, wmHeight: 100, wmWidth: 500"></div>
										</form>
									</li>
									<!-- /ko -->
									<li><button type="button" data-bind="visible: $root.isadvanced, click:addChoice">Add a choice</button></li>
								</ul>
							</section>
							<!-- /ko -->
							<!-- ko if: type().name=='m_n_x' -->
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='marking'}">
								<form class="form-horizontal">
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Minimum marks',property:multiplechoice.minMarks, max:multiplechoice.maxMarks }
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Maximum marks',property:multiplechoice.maxMarks, min:multiplechoice.minMarks}
									}"></div>
									<div class="control-group" data-bind="visible: !parent, template: {
										name: 'property',
										data: {label:'Penalty for revealing steps',property:stepsPenalty,min:0}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Minimum answers:',property:multiplechoice.minAnswers, max:multiplechoice.maxAnswers}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'property',
										data: {label:'Maximum answers:',property:multiplechoice.maxAnswers, min:multiplechoice.minAnswers}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'booleanproperty',
										data: {label:'Shuffle order of choices?', property:multiplechoice.shuffleChoices}
									}"></div>
									<div class="control-group" data-bind="template: {
										name: 'booleanproperty',
										data: {label:'Shuffle order of answers?', property:multiplechoice.shuffleAnswers}
									}"></div>
									<div class="control-group">
										<label>
											<span class="control-label">Selection type:</span>
											<div class="controls">
												<select data-bind="options: multiplechoice.displayTypes.m_n_x, value: multiplechoice.displayType, optionsText: 'niceName'"></select>
											</div>
										</label>
									</div>
									<div class="control-group" data-bind="template: {
										name: 'booleanproperty',
										data: {label: 'Custom marking matrix?', property: multiplechoice.customMarking}
									}"></div>
									<div class="control-group" data-bind="fadeVisible: multiplechoice.customMarking, template: {
										name: 'property',
										data: {label: 'Custom matrix expression', property: multiplechoice.customMatrix}
									}"></div>
								</form>
							</section>
							<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable(currentTab().id)=='choices'}">
								<div class="matrix">
									<label>Marking matrix:</label>
									<table class="multiplechoice">
										<thead>
											<tr>
												<td></td>
												<!-- ko foreach: {data: multiplechoice.answers, beforeRemove: Editor.beforeRemove, afterAdd: Editor.afterAdd} -->
													<th>
														<input type="text" data-bind="value:content, valueUpdate:'input'">
														<button type="button" class="delete" data-bind="click:function(){this.remove()}" title="Delete this answer"></button>
													</th>
												<!-- /ko -->
												<td>
													<button type="button" data-bind="visible: $root.isadvanced, click:addAnswer">Add Answer</button>
												</td>
											</tr>
										</thead>
										<tbody>
											<!-- ko foreach: {data: multiplechoice.choices, beforeRemove: Editor.beforeRemove, afterAdd: Editor.afterAdd} -->
												<tr>
													<th>
														<input type="text" data-bind="value:content, valueUpdate:'input'"/>
														<button type="button" class="delete" data-bind="click:remove" title="Delete this choice"></button>
													</th> 
													<!-- ko foreach: answers -->
														<td>
															<input type="text" class="marks monospace" data-bind="visible: !$parents[1].multiplechoice.customMarking(), value: marks, valueUpdate:'input'"/>
														</td>
													<!-- /ko -->
												</tr>
											<!-- /ko -->
											<tr><td><button type="button" data-bind="visible: $root.isadvanced, click:addChoice">Add Choice</button></td></tr>
										</tbody>
									</table>
								</div>
							</section>
							<!-- /ko -->
						</div>
					</div>
				</div>
			</div>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='advice'}">
			<div data-bind="writemaths:advice"></div>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='resources'}">
			<form data-bind="fileupload: resources" data-url="{% url 'upload_resource' object.pk object.slug %}">
				{% csrf_token %}
                <div class="control-group">
                    <label>
                        <h4 class="control-label">Upload an image</h4>
                        <div class="controls">
                            <input id="fileupload" type="file" name="files[]">
                        </div>
                    </label>
                </div>
			</form>
			<h4>Uploaded images</h4>
			<ul class="unstyled resources-list" data-bind="foreach: resources">
				<li class="resource clearfix">
					<div data-bind="visible: progress()<1" class="progress progress-striped active">
						<div class="bar" data-bind="style: {width: progress()+'%'}"></div>
					</div>
					<div data-bind="visible: progress()==1">
						<img class="thumbnail" data-bind="attr: {src: url, title: name}"/>
						<span data-bind="text: name"></span>
						<button type="button" class="delete" data-bind="click: $root.deleteResource" title="Delete this image"></button>
					</div>
				</li>
			</ul>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='exams'}">
			{% if object.exam_set.count %}
				<ul class="exams-list">
				{% for exam in object.exam_set.all %}
					<li class="exam">
						<a href="{% url 'exam_edit' exam.pk exam.slug %}">{{exam.name}}</a> ({{ exam.author.get_full_name }})
					</li>
				{% endfor %}
				</ul>
			{% else %}
				This question is not used in any exams.
			{% endif %}
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='access'}">
			<form class="form-horizontal">
				<div class="control-group">
					<label>
						<span class="control-label">Public visibility:</span>
						<div class="controls">
							<select data-bind="value: public_access, options: access_options, optionsText:'text',optionsValue:'value'"></select>
						</div>
					</label>
				</div>
			</form>
			<h4>Individual access rights</h4>
			<form class="form-horizontal" data-bind="submit: function(){}">
				<!-- ko foreach: {data: access_rights, afterAdd: Editor.afterAdd, beforeRemove: Editor.beforeRemove} -->
				<div class=control-group">
					<label>
						<span class="control-label" data-bind="text:name"></span>
						<div class="controls">
							<select data-bind="hasfocus: true, value: access_level, options: access_options, optionsText:'text',optionsValue:'value'"></select>
							<button type="button" class="delete" data-bind="click: remove" title="Remove this user's access"></button>
						</div>
					</label>
				</div>
				<!-- /ko -->
				<div class="control-group access-search">
					<label>
						<span class="control-label">Search for a user to give access to:</span>
						<div class="controls">
							<input id="search_author" type="text" size="30" data-bind="
								value: userAccessSearch,
								autocomplete: '{% url 'user_search' %}', 
								autocompleteCallback: function(user) { return {label: user.name, value: user.name} },
								autocompleteSelect: addUserAccess
								"/>
						</div>
					</label>
				</div>
			</form>
		</section>
	</div>

    <div class="modal hide fade" id="imagePickModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Insert image</h3>
        </div>
        <div class="modal-body">
			<form data-bind="fileupload: resources, afterupload: $root.insertImage" data-url="{% url 'upload_resource' object.pk object.slug %}">
				{% csrf_token %}
                <div class="control-group">
                    <label>
                        <span class="control-label">Upload an image</span>
                        <div class="controls">
                            <input id="fileupload" type="file" name="files[]">
                        </div>
                    </label>
                </div>
			</form>
            <ul class="unstyled resources-list" data-bind="foreach: resources">
				<li class="resource clearfix" data-bind="click: $root.insertImage"><img class="thumbnail" data-bind="attr: {src: url, title: name}"/><span data-bind="text: name"></span></li>
            </ul>
        </div>
    </div>
    <div class="modal hide fade" id="imageAttributeModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Image attributes</h3>
        </div>
		<div class="modal-body">
			<form class="form-horizontal">
				<div class="control-group">
					<label>
						<span class="control-label">Width</span>
						<div class="controls">
							<input type="text" class="span1" data-bind="value: imageModal.width"> px
						</div>
					</label>
				</div>
				<div class="control-group">
					<label>
						<span class="control-label">Height</span>
						<div class="controls">
							<input type="text" class="span1" data-bind="value: imageModal.height"> px
						</div>
					</label>
				</div>
				<div class="control-group">
					<label>
						<span class="control-label">Title text</span>
						<div class="controls">
							<input type="text" data-bind="value: imageModal.title">
						</div>
					</label>
				</div>
				<div class="control-group">
					<label>
						<span class="control-label">Alt text</span>
						<div class="controls">
							<input type="text" data-bind="value: imageModal.alt">
						</div>
					</label>
				</div>
			</form>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn" data-bind="click: function(){$('#imageAttributeModal').modal('hide');}">Cancel</button>
			<button type="button" class="btn btn-primary" data-bind="click: $root.changeImageAttributes">Apply</button>
		</div>
	</div>
{% endblock editor %}
