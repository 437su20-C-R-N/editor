{% extends "editor.html" %}
{% load user_link %}
{% load can_edit %}
{% load links %}
{% load sanitizer %}
{% load helplink %}
{% load editor_controls %}
{% load sstatic %}
{% load verbatim %}
{% load json_filter %}

{% block javascripts %}
    {{ block.super }}

    <!-- numbas -->
    <script src="{% sstatic 'js/numbas/R/R.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/numbas/R/en-gb.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/numbas/numbas.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/numbas/jme-display.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/numbas/jme-builtins.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/numbas/jme-variables.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/numbas/jme.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/numbas/editor-extras.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/numbas/math.js' %}" type="text/javascript"></script>
    <script src="{% sstatic 'js/numbas/util.js' %}" type="text/javascript"></script>

    {% for extension in extensions %}
        {% if extension.hasScript %}
            <script src="{% sstatic extension.scriptURL %}" type="text/javascript"></script>
        {% endif %}
    {% endfor %}

    <!-- question editor -->
    <script src="{% sstatic 'js/question/edit.js' %}" type="text/javascript"></script>

    <script type="text/javascript">
        (function() {
            window.item_json = {{item_json|json|safe}};
        })();
    </script>
{% endblock javascripts %}

{% block stylesheets %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% sstatic 'css/question/edit.css' %}"/>
{% endblock stylesheets %}

{% block content_container %}container-fluid{% endblock %}

{% block content %}
<div class="page-loading" data-bind="visible: false">
    <h1>Loading...</h1>
</div>
<div class="page-error">
    <div class="page-header text-danger">
        <h2>Error</h2>
    </div>
    <p class="text-lg">There was an error loading the page.</p>

    <pre class="trace"></pre>
</div>

<div class="loaded-content">
    <div class="page-header">
        <h1 class="name-header">
            <span class="glyphicon glyphicon-file"></span> <span data-bind="mathjaxHTML: name">{{object.name}}</span>
            <small class="pull-right" data-bind="if: current_stamp">
                <span class="label label-default stamp" data-bind="text: current_stamp().status_display"></span>
            </small>
        </h1>
    </div>
    <div class="row">
        <div class="col-sm-3 col-md-2 tabs">
            <ul id="controls" class="nav nav-pills nav-stacked">
                <li id="preview">
                    <a class="text-success" data-bind="attr: {href: item_json.previewURL, target: item_json.previewWindow}" title="Run this question in a new window (Ctrl+B)">
                        <span class="glyphicon glyphicon-play"></span>
                        Test Run
                    </a>
                </li>
                {% if user.is_authenticated %}
                <li id="stamp-dropdown" class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                        <span class="glyphicon glyphicon-flag"></span>
                        Feedback
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                    {% for name,description in stamp_choices %}
                        <li><a tabindex="-1" href="#" data-bind="click: addStamp('{{name}}')">{{description}}</a></li>
                    {% endfor %}
                    </ul>
                </li>
                {% endif %}
                <li id="download" class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                        <span class="glyphicon glyphicon-cloud-download"></span>
                        Download
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="{% url 'question_download' object.pk object.editoritem.slug %}">SCORM package</a></li>
                        <li><a href="{% url 'question_download' object.pk object.editoritem.slug %}">standalone .zip (no SCORM)</a></li>
                        <li><a href="{% url 'question_source' object.pk object.editoritem.slug %}">source</a></li>
                    </ul>
                 </li>
                 <li>
                    <a class="text-warning" href="{% url 'question_copy' object.pk object.editoritem.slug %}" target="_blank" title="Create your own copy of this question"><span class="glyphicon glyphicon-duplicate"></span> Make a copy</a>
                </li>
                <li>
                    <a href="#" class="text-danger" data-bind="click: deleteQuestion" title="Delete this question permanently">
                        <span class="glyphicon glyphicon-remove"></span> Delete
                        <form class="hidden" action="{% url 'question_delete' object.pk object.editoritem.slug %}" method="POST">
                            {% csrf_token %}
                        </form>
                    </a>
                </li>
            </ul>
            <hr>
            <ul class="nav nav-pills nav-stacked" data-bind="foreach: mainTabs">
                <li data-bind="visible: visible, css: {active: $root.currentTab() == $data}">
                    <a href="#" data-bind="click: $root.currentTab"><span data-bind="attr: {'class': 'glyphicon glyphicon-'+icon}"></span> <span data-bind="text: title"></span></a>
                </li>
            </ul>
        </div>

        <div class="col-sm-9 col-md-10 editing">
            <div class="tab-content">
                <!-- Settings tab -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='settings'}">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-sm-8">
                                <div class="form-group name">
                                    <label>Name</label>
                                    <input class="form-control input-lg" data-bind="textInput: name">
                                </div>
                                <div class="form-group description">
                                    <label>Description</label>
                                    <div data-bind="writemaths: description"></div>
                                    <p class="help-block">
                                        {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#description' subject='the description field' %}
                                        Describe what this question assesses.
                                    </p>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="panel panel-info">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">Metadata</h3>
                                    </div>
                                    <div class="panel-body">
                                        <div class="form-group">
                                            <label><span class="glyphicon glyphicon-user"></span> Author</label>
                                            <div class="media">
                                                <div class="media-left">
                                                    {% user_thumbnail object.editoritem.author 40 36 %}
                                                </div>
                                                <div class="media-body">
                                                    <p class="form-control-static">{% user_link object.editoritem.author %}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label><span class="glyphicon glyphicon-briefcase"></span> Project</label>
                                            <p class="form-control-static"><a target="_blank" href="{% url 'project_index' object.editoritem.project.pk %}">{{object.editoritem.project.name}}</a></p>
                                        </div>
                                        <div class="form-group">
                                            <label><span class="glyphicon glyphicon-copyright-mark"></span> Licence</label>
                                            <select class="form-control" data-bind="options: item_json.licences, value: licence, optionsText: 'short_name', optionsCaption: 'None specified'"></select>
                                            <p class="help-block">
                                                <small data-bind="visible: licence, with: licence"><a target="_blank" data-bind="visible: url, attr:{href:url}">Licence information</a></small>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <nav>
                            <ul class="pager">
                                <li class="next" data-bind="css: {ready: section_completed.settings}">
                                    <a title="Proceed to the next section" href="#" data-bind="click: setTab('statement')">Statement →</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </section>

                <!-- Question statement -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='statement'}">
                    <div class="form-group">
                        <label>Question statement</label>
                        <div data-bind="writemaths: statement"></div>
                        <p class="help-block">
                            {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#statement' subject='the question statement' %}
                            Give any introductory information the student needs. 
                        </p>
                    </div>

                    <hr>
                    <nav>
                        <ul class="pager">
                            <li class="previous">
                                <a title="Back to the previous section" href="#" data-bind="click: setTab('settings')">← Settings</a>
                            </li>
                            <li class="next" data-bind="css: {ready: section_completed.statement}">
                                <a title="Proceed to the next section" href="#" data-bind="click: setTab('variables')">Variables →</a>
                            </li>
                        </ul>
                    </nav>
                </section>

                <!-- Variables -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='variables'}">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-sm-12 col-md-6 col-lg-7" data-bind="with: currentVariable">
                                <form>
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input type="text" placeholder="Name" class="form-control name monospace" data-bind="value:name, valueUpdate: 'afterkeydown'"/>
                                        <span class="name-error" data-bind="text: nameError, visible: nameError"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>Data type</label>
                                        <select class="form-control" data-bind="options: templateTypes, value: templateType, optionsText: 'name'"></select>
                                    </div>
                                    <div class="form-group">
                                        <label>Value</label>

                                        <div data-bind="visible: templateType().id=='anything'">
                                            <textarea class="def" data-bind="valueUpdate: 'afterkeydown', codemirror: templateTypeValues.anything.definition, codemirrorMode: 'jme'"></textarea>
                                        </div>
                                        <div data-bind="visible: templateType().id=='number'">
                                            <input class="form-control" type="text" data-bind="value: templateTypeValues.number.value, valueUpdate: 'afterkeydown', autosize: {max: 500, min: 30, padding: 30, value: templateTypeValues.number.value}"/> 
                                            <p class="help-block">(a number)</p>
                                        </div>
                                        <div data-bind="visible: templateType().id=='range'" class="form-inline">
                                            Numbers between 
                                            <input class="form-control" type="text" data-bind="value: templateTypeValues.range.min, valueUpdate: 'afterkeydown', autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.range.min}"/>
                                            and
                                            <input class="form-control" type="text" data-bind="value: templateTypeValues.range.max, valueUpdate: 'afterkeydown', autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.range.max}"/>
                                            (inclusive) with step size
                                            <input class="form-control" type="text" data-bind="value: templateTypeValues.range.step, valueUpdate: 'afterkeydown', autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.range.step}"/>
                                        </div>
                                        <div data-bind="visible: templateType().id=='randrange'" class="form-inline">
                                            A random number between 
                                            <input class="form-control" type="text" data-bind="value: templateTypeValues.randrange.min, valueUpdate: 'afterkeydown', autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.randrange.min}"/>
                                            and
                                            <input class="form-control" type="text" data-bind="value: templateTypeValues.randrange.max, valueUpdate: 'afterkeydown', autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.randrange.max}"/>
                                            (inclusive) with step size
                                            <input class="form-control" type="text" data-bind="value: templateTypeValues.randrange.step, valueUpdate: 'afterkeydown', autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.randrange.step}"/>
                                        </div>
                                        <div data-bind="visible: templateType().id=='string'">
                                            <input class="form-control" type="text" data-bind="value: templateTypeValues.string.value, valueUpdate: 'afterkeydown', autosize: {max: 500, min: 30, padding: 10, value: templateTypeValues.string.value}"/> 
                                            <p class="help-block">(text string)</p>
                                        </div>
                                        <div data-bind="visible: templateType().id=='long string'">
                                            <div data-bind="writemaths: templateTypeValues['long string'].value"></div>
                                        </div>
                                        <div data-bind="visible: templateType().id=='list of numbers', with: templateTypeValues['list of numbers']">
                                            <input class="form-control" type="text" data-bind="value: commaValue, valueUpdate: 'afterkeydown', autosize: {max: 500, min: 30, padding: 10, value: commaValue}"/>
                                            <p class="help-block">(comma-separated list of numbers)</p>
                                        </div>
                                        <div data-bind="visible: templateType().id=='list of strings', with: templateTypeValues['list of strings']">
                                            <ul class="list-unstyled" data-bind="foreach: values.edit">
                                                <li>
                                                    <input class="form-control" type="text" data-bind="value: value, valueUpdate: 'afterkeydown', event: {blur: onBlur}, autosize: {max: 500, min: 30, padding: 10, value: value}"/>
                                                </li>
                                            </ul>
                                            <p class="help-block">(text strings)</p>
                                        </div>
                                        </div>
                                        <div class="help-block">
                                            <div class="value-error alert alert-danger" data-bind="visible: error().length>0, html: error">
                                            <div class="html-type-warning value-error alert alert-danger" data-bind="visible: value() && value().type=='html'">
                                                <p>This variable is an HTML node. HTML nodes can not be relied upon to work correctly when resuming a session - for example, attached event callbacks will be lost, and mathematical notation will likely also break.</p>
                                                <p>If this causes problems, try to create HTML nodes where you use them in content areas, instead of storing them in variables.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Description</label>
                                        <div data-bind="writemaths: description"></div>
                                        <p class="help-block">Describe what this variable represents, and list any assumptions made about its value.</p>
                                    </div>
                                </form>
                                <div data-bind="visible: dependencies().length>0" class="inline-names">
                                    <label>← Depends on:</label>
                                    <ul class="list-inline" data-bind="foreach: dependenciesObjects">
                                        <li><span class="btn btn-sm btn-info monospace" data-bind="click: setCurrent, text: name, css: {notdefined: notdefined}, attr: {title: title}"></span></li>
                                    </ul>
                                </div>
                                <div data-bind="visible: usedIn().length>0">
                                    <label>→ Used by:</label>
                                    <ul class="list-inline" data-bind="foreach: usedIn">
                                        <li><span class="btn btn-sm btn-info monospace" data-bind="click: $root.currentVariable, text: name"></span></li>
                                    </ul>
                                </div>

                            </div>
                            <div class="col-sm-12 col-md-6 col-lg-5">
                                <div class="panel panel-info variable-groups">
                                    <!-- ko foreach: allVariableGroups -->
                                    <div class="panel-heading">
                                        <h3 class="panel-title">
                                            <button type="button" class="pull-left btn btn-xs btn-link" data-bind="click: sort" title="Sort the variables in this group"><span class="glyphicon glyphicon-sort-by-alphabet"></span></button>
                                            <input class="transparent-input" type="text" data-bind="textInput: name, attr: {readonly: fixed}"/>
                                            <button type="button" class="pull-right btn btn-xs btn-link" data-bind="visible: !fixed, click: remove" title="Remove this variable group"><span class="glyphicon glyphicon-remove text-danger"></span></button>
                                        </h3>
                                    </div>
                                    <table class="table variable-list table-hover">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th class="name">Name</th>
                                                <th class="value">Generated Value</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody data-bind="css: {empty: variables().length==0}, sortable: {
                                            template: 'variable-template',
                                            data: $data.variables,
                                            options: {
                                                forcePlaceholderSize: true,
                                                placeholder: 'placeholder'
                                            }
                                        }">
                                        </tbody>
                                    </table>

                                    <script type="text/html" id="variable-template">
                                        <tr data-bind="css: {noname: !name(), active: $data==$root.currentVariable(), dependency: isDependency, danger: error().length>0}" class="variable-selector">
                                            <td class="lock-cell">
                                                <button type="button" class="btn btn-xs btn-link lock" data-bind="click: toggleLocked, css: {locked: locked}" title="Lock the value of this variable (editor only)">
                                                    <span class="glyphicon glyphicon-lock"></span>
                                                </button>
                                            </td>
                                            <td class="name monospace" data-bind="click: $root.currentVariable, text: name() ? name() : 'Unnamed', css: {'name-error': nameError()!=''}"></td>
                                            <td class="value-cell" data-bind="click: $root.currentVariable">
                                                <div class="value" data-bind="html: display"></div>
                                            </td>
                                            <td>
                                                <button class="btn btn-xs btn-link" type="button" title="Remove this variable" data-bind="click:remove">
                                                    <span class="glyphicon glyphicon-remove text-danger"></span>
                                                </button>
                                            </td>
                                        </tr>
                                    </script>

                                    <div class="panel-footer">
                                        <button type="button" class="btn btn-default add-variable" data-bind="click: addVariable, attr: {title: (variables().length ? 'Add another variable' : 'Add a variable')+' to '+name()}">
                                            <span class="glyphicon glyphicon-plus"></span>
                                            Add a variable
                                        </button>
                                    </div>

                                    <!-- /ko -->
                                </div>
                                <button class="btn btn-info btn-lg btn-block" type="button" data-bind="click: generateVariablePreview, visible: variables().length>0"><span class="glyphicon glyphicon-refresh"></span> Regenerate values</button>
                                <button class="btn btn-primary btn-block" type="button" data-bind="click: addVariableGroup"><span class="glyphicon glyphicon-plus"></span> New variable group</button>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <nav>
                        <ul class="pager">
                            <li class="previous">
                                <a title="Back to the previous section" href="#" data-bind="click: setTab('statement')">← Statement</a>
                            </li>
                            <li class="next" data-bind="css: {ready: section_completed.variables}">
                                <a title="Proceed to the next section" href="#" data-bind="click: setTab('parts')">Parts →</a>
                            </li>
                        </ul>
                    </nav>
                </section>

                <!-- Variable testing -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap(currentTab().id)=='variabletesting'}">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">
                                Condition to satisfy
                                {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#term-condition-to-satisfy' %}
                            </label>
                            <div class="col-sm-9">
                                <textarea class="def" data-bind="valueUpdate: 'afterkeydown', codemirror: variablesTest.condition, codemirrorMode: 'jme'"></textarea>
                                <p class="alert alert-danger" data-bind="visible: variablesTest.conditionError">Error: <span data-bind="html: variablesTest.conditionError"></span></p>
                            </div>
                        </div>
                        {% with form_label_class="col-sm-3" form_control_class="col-sm-9" %}
                        {% property 'variablesTest.maxRuns' 'Maximum number of runs' min=1 help_url='http://numbas-editor.readthedocs.org/en/latest/question-reference.html#term-maximum-number-of-runs' %}
                        {% endwith %}
                        <div class="form-group form-inline">
                            <div class="col-sm-offset-3">
                                <p data-bind="visible: !variablesTest.running()"><button class="btn btn-primary" type="button" data-bind="click: testVariables">Test condition</button> for <input class="form-control" type="number" data-bind="textInput: variablesTest.running_time, autosize: {value:variablesTest.running_time, max:100, min: 20}"/> seconds</p>
                                <p class="variable-test-running" data-bind="visible: variablesTest.running">Running for <span data-bind="text: variablesTest.time_remaining_display"></span>... <button type="button" data-bind="click: cancelVariablesTest">Cancel</button></p>
                            </div>
                        </div>
                    </form>
                    <div class="variable-test-advice alert alert-info" data-bind="visible: !variablesTest.running() && variablesTest.advice(), html: variablesTest.advice"></div>
                </section>

                <!-- Parts -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='parts'}">

                    <p class="text-right">
                        <button type="button" class="btn btn-link" data-bind="click: expand_all_parts"><span class="glyphicon glyphicon-expand"></span> Expand every part</button>
                        <button type="button" class="btn btn-link" data-bind="click: collapse_all_parts"><span class="glyphicon glyphicon-collapse-up"></span> Collapse every part</button>
                    </p>

                    <div class="panel-group parts" role="tablist" aria-multiselectable="true">
                        <!-- ko foreach: allParts-->
                        <div class="panel part" data-bind="
                                visible: isRootPart() || parent().open(), 
                                attr: {'data-path': path},
                                css: {'open': open, 'panel-primary': isRootPart, 'panel-success': isGap, 'panel-info': isStep, 'root': isRootPart, 'gap': isGap, 'step': isStep}
                            ">
                            <div class="panel-heading" data-bind="restrictedClick: toggleOpen" clickable>
                                <div class="pull-right">
                                    <div class="btn-group part-header-controls">
                                        <button type="button" class="btn btn-link" data-bind="click: moveUp, visible: canMove('up')" title="Move this part up one place"><span class="glyphicon glyphicon-arrow-up"></span></button>
                                        <button type="button" class="btn btn-link" data-bind="click: moveDown, visible: canMove('down')" title="Move this part down one place"><span class="glyphicon glyphicon-arrow-down"></span></button>
                                    </div>
                                    <button type="button" class="btn btn-link" title="Remove this part" data-bind="click: remove"><span class="glyphicon glyphicon-remove text-danger"></span></button>
                                </div>
                                <h3 class="panel-title form-inline" clickable>
                                    <span clickable class="glyphicon" data-bind="css: {'glyphicon-triangle-right': !open(), 'glyphicon-triangle-bottom': open}"></span>
                                    <strong clickable data-bind="text: header"></strong>
                                    <select class="form-control type" data-bind="options: availableTypes, value:type, optionsText: 'niceName'"></select>
                                </h3>
                            </div>
                            <div data-bind="fadeVisible: open">
                                <div class="panel-body">
                                    <ul class="col-sm-3 nav nav-pills nav-stacked part-tabs" data-bind="foreach: tabs">
                                        <li data-bind="css: {active: ko.unwrap($parent.currentTab().id) == $data.id}">
                                            <a href="#" data-bind="click: $parent.currentTab"><span data-bind="attr: {'class': 'glyphicon glyphicon-'+icon}"></span> <span data-bind="text: title"></span></a>
                                        </li>
                                    </ul>
                                    <div class="col-sm-9 tab-content">
                                        <section class="tab-pane" data-bind="css: {active: ko.unwrap(currentTab().id)=='prompt'}">
                                            <div data-bind="writemaths: prompt, preambleCSS: $root.preamble.css, tinymce_plugins: ['gapfill'], showButtons: {gapfill: function(){return $data.type().name=='gapfill'}}"></div>

                                            <p class="help-block">
                                                {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-parts.html#term-prompt' subject='the part prompt' %}
                                                Ask the student a question, and give any hints about how they should answer this part.
                                            </p>
                                        </section>

                                        {% with form_label_class="col-sm-4" form_control_class="col-sm-8" %}
                                        {% for name,template in partNames %}
                                            <!-- ko if: type().name=='{{name}}' -->
                                                <!-- ko with: type().model -->
                                                {% include template %}
                                                <!-- /ko -->
                                            <!-- /ko -->
                                            {% endfor %}
                                        {% endwith %}

                                        <section class="tab-pane" data-bind="css: {active: ko.unwrap(currentTab().id)=='scripts'}">
                                            <form class="form-inline" data-bind="foreach: scripts">
                                                <div class="script control-group">
                                                    <label class="control-label">
                                                        <p>
                                                        <span data-bind="text: displayName"></span><span data-bind="if: active"> (active)</span>
                                                        </p>
                                                    </label>
                                                    <div class="controls">
                                                        <textarea data-bind="valueUpdate: 'afterkeydown', codemirror: script, codemirrorMode: 'javascript'"></textarea>
                                                        <p class="order" data-bind="visible: name!='constructor'">Run this script <select class="form-control" data-bind="options: orderOptions, value: orderItem, optionsText: 'niceName'"></select> the built-in script.</p>
                                                        <p class="order" data-bind="visible: name=='constructor'">This script runs after the built-in script.</p>
                                                    </div>
                                                </div>
                                            </form>
                                        </section>
                                        <section class="tab-pane" data-bind="css: {active: ko.unwrap(currentTab().id)=='adaptivemarking'}">
                                            <h4>Variable replacement</h4>
                                            <div class="variable-replacements">
                                                <table class="table" data-bind="fadeVisible: variableReplacements().length">
                                                    <thead>
                                                        <tr>
                                                            <th>Variable</th>
                                                            <th>Answer to use</th>
                                                            <th>Must be answered?</th>
                                                        </th>
                                                    </thead>
                                                    <tbody data-bind="foreach: variableReplacements">
                                                        <tr>
                                                            <td><input class="form-control variable-name monospace" data-bind="value: variable"/></td>
                                                            <td>
                                                                <select class="form-control replace-with" data-bind="options: availableParts, optionsText: 'nicePath', optionsValue: 'path', value: replacement"/>
                                                            </td>
                                                            <td>
                                                                <input type="checkbox" data-bind="checked: must_go_first"/>
                                                            </td>
                                                            <td>
                                                                <button type="button" class="delete btn btn-link" data-bind="click: part.deleteVariableReplacement" title="Delete this replacement"><span class="glyphicon glyphicon-remove text-danger"></span></button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <div class="text-right">
                                                    <button class="btn btn-sm btn-primary add-variable-replacement" data-bind="click: addVariableReplacement"><span class="glyphicon glyphicon-plus"></span> <span data-bind="text: variableReplacements().length? 'Add another replacement' : 'Add a variable replacement'">Add a variable replacement</span></button>
                                                </div>

                                                <form class="form-horizontal">
                                                    <div class="control-group">
                                                        <label class="control-label">
                                                            Variable replacement strategy:
                                                        </label>
                                                        <div class="controls">
                                                            <select class="form-control" data-bind="options: variableReplacementStrategies, value: variableReplacementStrategy, optionsText: 'niceName'"></select>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </section>
                                    </div>
                                </div>
                                <div class="panel-footer clearfix">
                                    <div class="pull-left">
                                        <button type="button" class="btn btn-default" data-bind="click: copy"><span class="glyphicon glyphicon-duplicate"></span> Copy this part</button>
                                        <button type="button" class="btn btn-default" data-bind="click: replaceWithGapfill, visible: canBeReplacedWithGap"><span class="glyphicon glyphicon-tasks"></span> Replace part <strong data-bind="text:indexLabel"></strong> with a gapfill</button>
                                    </div>
                                    <div class="pull-right">
                                        <button type="button" class="btn btn-default" data-bind="click: addGap, visible: type().name=='gapfill'"><span class="glyphicon glyphicon-plus"></span> Add a gap to part <strong data-bind="text:indexLabel"></strong></button>
                                        <button type="button" class="btn btn-info" data-bind="click: addStep, visible: isRootPart"><span class="glyphicon glyphicon-plus"></span> Add a step to part <strong data-bind="text:indexLabel"></strong></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /ko -->
                    </div>

                    <button class="btn btn-primary" type="button" data-bind="click:addPart, text: parts().length ? 'Add another part' : 'Add a part'"></button>

                    <hr>
                    <nav>
                        <ul class="pager">
                            <li class="previous">
                                <a title="Back to the previous section" href="#" data-bind="click: setTab('variables')">← Variables</a>
                            </li>
                            <li class="next" data-bind="css: {ready: section_completed.parts}">
                                <a title="Proceed to the next section" href="#" data-bind="click: setTab('advice')">Advice →</a>
                            </li>
                        </ul>
                    </nav>
                </section>


                <!-- Advice -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='advice'}">
                    <div class="form-group">
                        <label>Advice</label>
                        <div data-bind="writemaths: advice"></div>
                        <p class="help-block">
                            {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#advice' subject='the advice section' %}
                            Give a worked solution to the whole question. 
                        </p>
                    </div>

                    <hr>
                    <nav>
                        <ul class="pager">
                            <li class="previous">
                                <a title="Back to the previous section" href="#" data-bind="click: setTab('parts')">← Parts</a>
                            </li>
                            <li class="next" data-bind="css: {ready: section_completed.advice}">
                                <a title="Proceed to the next section" href="#" data-bind="click: setTab('access')">Access →</a>
                            </li>
                        </ul>
                    </nav>
                </section>

                <!-- Access -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='access'}">
                    <div class="panel panel-warning" data-bind="visible: !published() && !all_sections_completed()">
                        <div class="panel-heading">
                            <h3 class="panel-title">Publish</h3>
                        </div>
                        <div class="panel-body">
                            <p>At the moment, access to this question is restricted to members of the project this question belongs to and any other users you've explicitly granted access to.</p>
                            <p>Complete each of the following tasks before you publish this question:</p>
                            <ul class="list-unstyled" data-bind="foreach: mainTabs">
                                <li data-bind="visible: $root.section_completed[id]!==undefined">
                                <h4><a href="#" data-bind="text: title, click: $root.setTab(id), css: {'text-success': $root.section_completed[id], 'text-danger': !ko.unwrap($root.section_completed[id])}"></a></h4>
                                    <ul data-bind="foreach: $root.section_tasks[id]">
                                        <li data-bind="css: {'text-success': done, 'text-danger': !done()}">
                                            <span class="glyphicon" data-bind="css:{'glyphicon-ok':done, 'glyphicon-alert':!done()}"></span>
                                            <span data-bind="text: text"></span> 
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="panel panel-warning" data-bind="visible: !published() && all_sections_completed()">
                        <div class="panel-heading">
                            <h3 class="panel-title">Publish</h3>
                        </div>
                        <div class="panel-body">
                            <p>At the moment, this question is restricted to members of the project this question belongs to and any other users you've explicitly granted access to.</p>
                            <p>Publish your question so that others can see it.</p>
                            <form method="POST" action="{% url 'item_publish' object.editoritem.pk %}">
                                <button class="btn btn-danger" type="submit">Publish</button>
                                {% csrf_token %}
                            </form>
                        </div>
                    </div>
                    <div class="panel panel-success" data-bind="visible: published">
                        <div class="panel-heading">
                            <h3 class="panel-title">Publish</h3>
                        </div>
                        <div class="panel-body">
                            <p>This question has been published to the public question database.</p>
                        </div>
                    </div>
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title">Access rights</h3>
                        </div>
                        <table class="table">
                            <thead>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="glyphicon glyphicon-globe"></span> Public access</td>
                                    <td>
                                        <select class="form-control" data-bind="visible: published, value: public_access, options: access_options, optionsText:'text',optionsValue:'value'"></select>
                                        <em data-bind="visible: !ko.unwrap(published)">This question has not been published</em>
                                    </td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>{% user_thumbnail object.editoritem.author 20 15 %} {% user_link object.editoritem.author new_window=True%}</td>
                                    <td>
                                        Owner
                                    </td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td><span class="glyphicon glyphicon-briefcase"></span> Members of <a href="{% url 'project_index' object.editoritem.project.pk %}">{{object.editoritem.project.name}}</a></td>
                                    <td>
                                        Access granted by project owner
                                    </td>
                                    <td></td>
                                </tr>
                                <!-- ko foreach: {data: access_rights, afterAdd: Editor.afterAdd} -->
                                <tr>
                                    <td data-bind="html: link"></td>
                                    <td>
                                        <select class="form-control" data-bind="hasfocus: true, value: access_level, options: access_options, optionsText:'text',optionsValue:'value'"></select>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-link" data-bind="click: remove" title="Remove this user's access"><span class="glyphicon glyphicon-remove text-danger"></span></button>
                                    </td>
                                </tr>
                                <!-- /ko -->
                            </tbody>
                        </table>
                        <div class="panel-body">
                            <label>Give access to</label>
                            <input class="form-control" id="search_author" type="text" placeholder="Full name or username" size="30" data-bind="
                                value: userAccessSearch,
                                autocomplete: '{% url 'user_search' %}', 
                                autocompleteCallback: function(user) { return {label: user.name, value: user.name} },
                                autocompleteSelect: addUserAccess
                                "
                            />
                        </div>
                    </div>

                    <div class="panel panel-info">
                        <div class="panel-heading">
                            <h3 class="panel-title">Access Links</h3>
                        </div>
                        <div class="panel-body">
                            <p>Share these links to give automatic access to this question. Be careful about who you share these with - whoever clicks on the link will be given access.</p>
                        </div>
                        <ul class="share-links list-group">
                            <li class="list-group-item">
                                <label>View</label>
                                <input class="share-link form-control" readonly value="{{SITE_ROOT}}{% url 'share_question' 'view' object.editoritem.share_uuid_view %}">
                            </li>
                            <li class="list-group-item">
                                <label>Edit</label>
                                <input class="share-link form-control" readonly value="{{SITE_ROOT}}{% url 'share_question' 'edit' object.editoritem.share_uuid_edit %}">
                            </li>
                        </ul>
                    </div>

                    <nav>
                        <ul class="pager">
                            <li class="previous">
                                <a title="Back to the previous section" href="#" data-bind="click: setTab('advice')">← Advice</a>
                            </li>
                        </ul>
                    </nav>
                </section>

                <!-- Extensions and scripts -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='extensions'}">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="panel panel-info">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Extensions {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#term-extensions' %}</h4>
                                    </div>
                                    <div class="panel-body">
                                        <ul class="extensions" data-bind="foreach: extensions">
                                            <li class="extension">
                                                <label>
                                                    <span class="checkbox"><input type="checkbox" data-bind="checked: used"></span>
                                                    <span data-bind="text:name"></span> <a data-bind="if: url, attr: {href:url, title: 'Documentation on the '+name+' extension'}" target="_blank"><small class="glyphicon glyphicon-book"></small></a>
                                                </label>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="panel-footer">
                                        <a class="btn btn-link btn-block" href="{% url 'extension_new' %}"><span class="glyphicon glyphicon-cloud-upload"></span> Upload a new extension</a>
                                    </div>
                                </div>
                                <div class="panel panel-info">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Rulesets {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#rulesets' subject='rulesets' %}</h4>
                                    </div>
                                    <ul class="list-group">
                                        <!-- ko foreach: {data: rulesets, afterAdd: Editor.afterAdd} -->
                                        <li class="list-group-item ruleset">
                                            <button type="button" class="pull-right btn btn-link btn-sm" data-bind="click:remove" title="Delete this ruleset"><span class="glyphicon glyphicon-remove"></span></button>
                                            <div class="form-group">
                                                <label>Name</label>
                                                <input type="text" placeholder="Name" class="name form-control" data-bind="textInput: name"/>
                                            </div>
                                            <div class="form-group">
                                                <label>Definition</label>
                                                <listbox params="items: sets"></listbox>
                                            </div>
                                        </li>
                                        <!-- /ko -->
                                    </ul>
                                    <div class="panel-footer">
                                        <button type="button" class="btn btn-primary" data-bind="click:addRuleset"><span class="glyphicon glyphicon-plus"></span> <span data-bind="text: rulesets().length ? 'Add another ruleset' : 'Add a ruleset'"></span></button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <div id="functions" class="panel panel-default">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">Functions {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#functions-rulesets' subject='functions' %}</h3>
                                    </div>
                                    <ul class="list-group">
                                        <!-- ko foreach: {data: functions, afterAdd: Editor.afterAdd} -->
                                        <li class="function list-group-item">
                                            <div class="row">
                                                <div class="form-group col-sm-8">
                                                    <label>
                                                        Name {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#term-name' %}
                                                    </label>
                                                    <input class="form-control" placeholder="Name" type="text" data-bind="value: name, valueUpdate: 'afterkeydown'">
                                                </div>
                                                <div class="form-group col-sm-3">
                                                    <label>
                                                        Language {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#term-language' subject='languages' %}
                                                    </label>
                                                    <select class="form-control" data-bind="options: languages, value: language"></select>
                                                </div>
                                                <div class="col-sm-1">
                                                    <button type="button" class="delete btn btn-sm btn-link pull-right" data-bind="click:remove" title="Delete this function"><span class="glyphicon glyphicon-remove"></span></button>
                                                </div>
                                            </div>
                                            <div class="form-group form-inline">
                                                <label>Type</label>
                                                <ul class="list-inline parameters">
                                                    <!-- ko foreach: parameters -->
                                                    <li class="parameter">
                                                        <div class="input-group">
                                                            <input placeholder="Name" type="text" class="form-control" data-bind="textInput: name, autosize: name">
                                                            <span class="input-group-btn">
                                                                <select class="btn btn-info" data-bind="options: $parent.types, value: type" title"Type of this parameter"></select>
                                                                <button type="button" class="btn btn-danger" title="Remove this parameter" data-bind="click: remove"><span class="glyphicon glyphicon-remove"></span></button>
                                                            </span>
                                                        </div>
                                                    </li>
                                                    <!-- /ko -->
                                                    <li>
                                                        <button type="button" class="btn btn-xs btn-info" title="Add a parameter" data-bind="click: addParameter"><span class="glyphicon glyphicon-plus"></span></button>
                                                    </li>
                                                    <li class="output">
                                                        <select class="form-control btn-info" data-bind="options: types, value: type" title="Output type"></select>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div clas="form-group">
                                                <label>
                                                    Definition:
                                                </label>
                                                <textarea data-bind="codemirror: definition, codemirrorMode: language, valueUpdate: 'afterkeydown'"></textarea>
                                                <div class="alert alert-danger" data-bind="visible: error().length>0">
                                                    <span class="glyphicon glyphicon-alert"></span> <span class="errortext" data-bind="html: error"></span>
                                                </div>
                                            </div>
                                        </li>
                                        <!-- /ko -->
                                    </ul>
                                    <div class="panel-footer">
                                        <button type="button" class="btn btn-primary" data-bind="click:addFunction"><span class="glyphicon glyphicon-plus"></span> <span data-bind="text: functions().length ? 'Add another function' : 'Add a function'"></span></button>
                                    </div>
                                </div>
                                <div id="preamble" class="panel panel-default">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">
                                            Preamble
                                            {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#preamble' %}
                                        </h3>
                                    </div>
                                    <div class="panel-body">
                                        <form>
                                            <div class="form-group">
                                                <label>Javascript</label>
                                                <textarea data-bind="valueUpdate: 'afterkeydown', codemirror: preamble.js, codemirrorMode: 'javascript'"></textarea>
                                                <div class="help-block">
                                                    This script will run after the question's variable have been generated but before the HTML is attached.
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>CSS</label>
                                                <textarea data-bind="valueUpdate: 'afterkeydown', codemirror: preamble.css, codemirrorMode: 'css'"></textarea>
                                                <div class="help-block">
                                                    Apply styling rules to the question's content.
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </section>

                <!-- Exams using this question -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='exams'}">
                    {% if object.exams_using_this.count %}
                    <p>This question is used in the following exam{{object.exams_using_this.count|pluralize}}:</p>
                        <ul class="exams-list">
                        {% for exam in object.exams_using_this.all %}
                            <li class="exam">
                                <a href="{% url 'exam_edit' exam.pk exam.editoritem.slug %}">{{exam.editoritem.name}}</a> by {% user_link exam.editoritem.author %}
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        This question is not used in any exams.
                    {% endif %}
                </section>

                <!-- Other versions -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='network'}">
                    {% if object.editoritem.network|length == 1 %}
                        <p>There is only one version of this question.<p>
                    {% else %}
                        <table class="network table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th><span class="glyphicon glyphicon-comment"></span> Status</th>
                                    <th><span class="glyphicon glyphicon-user"></span> Author</th>
                                    <th><span class="glyphicon glyphicon-time"></span> Last Modified</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ei2 in object.editoritem.network %}
                                <tr class="network-item{% if ei2 == object.editoritem %} active{% endif %}">
                                    <td>{% if ei2 != object.editoritem %}{% question_link ei2.rel_obj %}{% else %}{{ei2.name}}{% endif %}</td>
                                    <td>{% include "stamp_column.html" with record=ei2 %}</td>
                                    <td>{% user_link ei2.author %}</td>
                                    <td>{{ ei2.last_modified|date:"d/m/Y H:i" }}</td>

                                    <td class="admin">
                                        {% if ei2 != object.editoritem %}
                                        <a class="btn btn-link" href="{% url 'question_preview' ei2.rel_obj.pk ei2.slug %}" target="_blank" title="Preview this version"><span class="glyphicon glyphicon-play"></span></a>
                                        <a class="btn btn-link" href="{% url 'question_compare' object.pk ei2.rel_obj.pk %}" title="Compare with this version"><span class="glyphicon glyphicon-transfer"></span></a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}

                    {% with object.incoming_pull_requests.open as pull_requests %}
                    {% if pull_requests.exists %}
                    <h2>Request{{pull_requests.count|pluralize}} to merge</h2>
                    <ul>
                        {% for pr in pull_requests %}
                        <li class="pull-request">
                            <p>{% user_link pr.owner %} would like you to replace this question with {% question_link pr.source %}.</p>
                            <p>Here's what's changed:</p>
                            <blockquote class="comment">{{ pr.comment|strip_html|safe }}</blockquote>
                            <div class="responses">
                                <form method="post" action="{% url 'question_pullrequest_accept' pr.pk %}">{% csrf_token %}<button class="btn accept-pr">Accept</button></form>
                                <form method="post" action="{% url 'question_pullrequest_reject' pr.pk %}">{% csrf_token %}<button class="btn reject-pr">Reject</button></form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    {% endwith %}
                </section>

                <!-- Editing history -->
                <section class="tab-pane" data-bind="css: {active: ko.unwrap($root.currentTab().id)=='history'}">

                    <div class="timeline-write-comment" data-bind="with: commentwriter">
                        <button class="btn btn-primary" data-bind="visible: !writingComment(), click: writingComment" type="button"><span class="glyphicon glyphicon-comment"></span> Write a comment</button>
                        <form action="{% url 'comment_on_question' object.pk object.editoritem.slug %}" data-bind="fadeVisible: writingComment, submit: submitComment">
                            <h4>Comment</h4>
                            <div data-bind="writemaths: commentText"></div>
                            <div class="buttons">
                                <button type="Submit" class="btn btn-primary" data-bind="attr: {disabled: commentIsEmpty}">Submit</button>
                                <button type="button" class="btn btn-default" data-bind="click: cancelComment">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div class="timeline">
                        {% for item in object.editoritem.timeline.all %}
                            {% include item.object.timelineitem_template %}
                        {% endfor %}
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
