{% extends "editor.html" %}
{% load verbatim %}

{% block javascripts %}
    {{ block.super }}

    <!-- question editor -->
    <script src="{{ STATIC_URL }}js/numbas/R/R.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}js/numbas/R/en-gb.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}js/numbas/numbas.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}js/question/edit.js" type="text/javascript"></script>

    <script type="text/javascript">
        (function() {
            if (!window.Editor) {
                window.Editor = {};
            }
            var Editor = window.Editor;
            Editor['preview_url'] = '{% url question_preview object.pk object.slug %}';
            Editor['download_url'] = '{% url question_download object.pk object.slug %}';
            Editor.questionJSON = {% autoescape off %}{{question.as_json}}{% endautoescape %};
        })();
    </script>
{% endblock javascripts %}

{% block content %}
    {{ block.super }}
    
    {% if user.username == object.author.username or user.is_superuser %}
		{% verbatim %}
			<script type="text/x-jquery-tmpl" id="questionTemplate">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {property:name,label:'Question name:'}
				}"></div>
				<div>
					<label>Tags:</label>
					<div data-bind="listbox: tags"></div>
				</div>
			</div>


			{{wrap(this,{label:"Statement",show:true}) '#folder'}}
				<div style="padding-top:0.7em;">
					<div data-bind="writemaths:statement"></div>
				</div>
			{{/wrap}}

			{{wrap(this,{label:"Rulesets"}) "#folder"}}
			<div class="rulesets">
				<ul class="editlist" data-bind="template:{
					name:'ruleset',
					foreach: rulesets,
					beforeRemove: function(elem) { $(elem).slideUp(150,function(){$(this).remove()}) },
					afterAdd: function(elem) { $(elem).hide().slideDown(150) }
				}"></ul>
				<button data-bind="click:addRuleset, text: rulesets().length ? 'Add another ruleset' : 'Add a ruleset'"></button>
			</div>
			{{/wrap}}

			{{wrap(this,{label:"Variables",show:true}) '#folder'}}
				<div>
					<table class="variables editlist">
						<thead data-bind="visible: variables().length>0">
							<th/>
							<th>Name</th>
							<th>Definition</th>
							<th>Computed value</th>
						</thead>
						<tbody data-bind="template:{
							name:'variable',
							foreach: variables,
							beforeRemove: function(elem) { $(elem).find('td>div').slideUp(150,function() {$(this).parent().parent().remove()}) },
							afterAdd: function(elem) { $(elem).find('td>div').hide().slideDown(150).end().find('.name').focus(); },
						}, sortableList: variables"></tbody>
						<tr>
							<td/>
							<td><button data-bind="click:addVariable, text: variables().length ? 'Add another variable' : 'Add a variable'"></button></td>
							<td></td>
							<td><button data-bind="click: computeVariables, visible: variables().length>0">Regenerate values</button></td>
						</tr>
					</table>
				</div>
			{{/wrap}}

			{{wrap(this,{label:"Functions",show:false}) '#folder'}}
				<div>
					<ol class="editlist" data-bind="template:{
						name: 'function',
						foreach: functions,
						beforeRemove: function(elem) { $(elem).slideUp(150,function(){$(this).remove()}) },
						afterAdd: function(elem) { $(elem).hide().slideDown(150) }
					}"></ol>
					<button data-bind="click:addFunction, text: functions().length ? 'Add another function' : 'Add a function'"></button>
				</div>
			{{/wrap}}

			{{wrap(this,{label:"Parts",show:true}) '#folder'}}
				<div>
					<ol class="editlist" data-bind="template:{
						name: 'part',
						foreach: parts,
						beforeRemove: function(elem) { $(elem).slideUp(150,function(){$(this).remove()}) },
						afterAdd: function(elem) { $(elem).hide().slideDown(150) }
					}"></ol>
					<button data-bind="click:addPart, text: parts().length ? 'Add another part' : 'Add a part'"></button>
				</div>
			{{/wrap}}

			{{wrap(this,{label:"Advice"}) '#folder'}}
				<div style="padding-top:0.7em;">
					<div data-bind="writemaths:advice"></div>
				</div>
			{{/wrap}}
		</script>
	
		<script type="text/x-jquery-tmpl" id="part">
			<li class="part">
				<div data-bind="foldlist: $data, label: type().niceName, show:true">
					<div class="properties">
						<div>
							<label>Part type: </label>
							<select data-bind="options: types, value:type, optionsText: 'niceName'"></select>
						</div>
						<div data-bind="fadeVisible: type().has_marks===true, template: {
							name: 'property',
							templateOptions: {label:'Marks:',property:marks, type:'number'}
						}"></div>
					</div>
					<div data-bind="visible: $data.parent==null || $data.parent.type().name!='gapfill' || $data.parent.steps().contains($data)">
						Prompt:
						<div data-bind="writemaths: prompt"></div>
					</div>
					<div style="margin-top:1em;" data-bind="template: type"></div>
					<div class="steps fold" data-bind="visible:parent==null">
						<div id="folder-header">Steps</div>
						<div id="folder">
							<div class="properties">
								<div data-bind="fadeVisible: steps().length>0, template: {
									name: 'property',
									templateOptions: {label:'Penalty for revealing steps (marks):',property:stepsPenalty, type:'number'}
								}"></div>
							</div>
							<ol class="editlist" data-bind="template:{
								name: 'part',
								foreach: steps,
								beforeRemove: function(elem) { $(elem).slideUp(150,function(){$(this).remove()}) },
								afterAdd: function(elem) { $(elem).hide().slideDown(150) }
							}"></ol>
							<button data-bind="click:addStep, text: steps().length ? 'Add another step' : 'Add a step'"></button>
						</div>
					</div>
				</div>
			</li>
		</script>
			
		<script type="text/x-jquery-tmpl" id="information">	
		</script>
	
		<script type="text/x-jquery-tmpl" id="gapfill">
			<div class="gaps fold">
				<div id="folder-header">Gaps</div>
				<div id="folder">
					<ol class="editlist" data-bind="template:{
						name: 'part',
						foreach: gapfill.gaps,
						beforeRemove: function(elem) { $(elem).slideUp(150,function(){$(this).remove()}) },
						afterAdd: function(elem) { $(elem).hide().slideDown(150) }
					}"></ol>
					<button data-bind="click:addGap, text: gapfill.gaps().length ? 'Add another gap' : 'Add a gap'"></button>
				</div>
			</div>
		</script>
	
		<script type="text/x-jquery-tmpl" id="jme">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Correct answer:',property:jme.answer}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Answer simplification rules:',property:jme.answerSimplification}
				}"></div>
			</div>
			{{wrap(this,{label:'Checking accuracy'}) '#folder'}}
			<div class="properties">
				<div>
					<label>Checking type: </label>
					<select data-bind="options: jme.checkingTypes, value: jme.checkingType, optionsText:'niceName'"></select>
				</div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Checking accuracy:',property:jme.checkingType().accuracy, type:'number',min:0}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Points to check:',property:jme.vset.points, type:'number',min:0}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Checking range start:',property:jme.vset.start, type:'number',max:jme.vset.end}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Checking range end:',property:jme.vset.end, type:'number',min:jme.vset.start}
				}"></div>
			</div>
			{{/wrap}}

			{{wrap(this,{label:'Maximum length restriction'}) '#folder'}}
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum length:',property:jme.maxlength.length, type:'number',min:0}
				}"></div>
				<div data-bind="fadeVisible: jme.maxlength.length()>0">
					<div data-bind="template: {
						name:'percentproperty',
						templateOptions: {label:'Partial credit for long answer:',property:jme.maxlength.partialCredit}
					}"></div>
					<div>
						Warning message:
						<div data-bind="writemaths: jme.maxlength.message"></div>
					</div>
				</div>
			</div>
			{{/wrap}}

			{{wrap(this,{label:'Minimum length restriction'}) '#folder'}}
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum length:',property:jme.minlength.length, type:'number',min:0}
				}"></div>
				<div data-bind="fadeVisible: jme.minlength.length()>0">
					<div data-bind="template: {
						name:'percentproperty',
						templateOptions: {label:'Partial credit for short answer:',property:jme.minlength.partialCredit}
					}"></div>
					<div>
						Warning message:
						<div data-bind="writemaths: jme.minlength.message"></div>
					</div>
				</div>
			</div>
			{{/wrap}}
			{{wrap(this,{label:'Required strings'}) '#folder'}}
			<div class="properties">
				<div>
					<label>Required strings:</label>
					<div data-bind="listbox:jme.musthave.strings"></div>
				</div>
				<div data-bind="fadeVisible: jme.musthave.strings().length>0">
					<div data-bind="template: {
						name:'percentproperty',
						templateOptions: {label:'Partial credit for not using all required strings:',property:jme.musthave.partialCredit}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: {label:'Show required strings in warning?', property:jme.musthave.showStrings}
					}"></div>
					<div>
						Warning message:
						<div data-bind="writemaths: jme.musthave.message"></div>
					</div>
				</div>
			</div>
			{{/wrap}}
			{{wrap(this,{label:'Forbidden strings'}) '#folder'}}
			<div class="properties">
				<div>
					<label>Forbidden strings:</label>
					<div data-bind="listbox:jme.notallowed.strings"></div>
				</div>
				<div data-bind="fadeVisible: jme.notallowed.strings().length>0">
					<div data-bind="template: {
						name:'percentproperty',
						templateOptions: {label:'Partial credit for using forbidden strings:',property:jme.notallowed.partialCredit}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: {label:'Show forbidden strings in warning?', property:jme.notallowed.showStrings}
					}"></div>
					<div>
						Warning message:
						<div data-bind="writemaths: jme.notallowed.message"></div>
					</div>
				</div>
			</div>
			{{/wrap}}
		</script>
	
		<script type="text/x-jquery-tmpl" id="numberentry">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum value:',property:numberentry.minValue}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum value:',property:numberentry.maxValue}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Must answer be an integer?', property:numberentry.integerAnswer}
				}"></div>
				<div data-bind="fadeVisible: numberentry.integerAnswer,
				template: {
					name:'percentproperty',
					templateOptions: {label:'Partial credit for non-integer answer:',property:numberentry.partialCredit}
				}"></div>
			</div>
		</script>
	
		<script type="text/x-jquery-tmpl" id="patternmatch">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Answer pattern:',property:patternmatch.answer}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Correct answer:',property:patternmatch.displayAnswer}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Must answer be in the correct case?', property:patternmatch.caseSensitive}
				}"></div>
				<div data-bind="
				fadeVisible:patternmatch.caseSensitive,
				template: {
					name:'percentproperty',
					templateOptions: {label:'Partial credit for answer not matching case:',property:patternmatch.partialCredit}
				}"></div>
			</div>
		</script>
	
	
		<script type="text/x-jquery-tmpl" id="1_n_2">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum marks:',property:multiplechoice.minMarks, type: 'number', max:multiplechoice.maxMarks }
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum marks:',property:multiplechoice.maxMarks, type: 'number', min:multiplechoice.minMarks}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Shuffle order of choices?', property:multiplechoice.shuffleChoices}
				}"></div>
				<label>Selection type:</label><select data-bind="options: multiplechoice.displayTypes['1_n_2'], value: multiplechoice.displayType, optionsText: 'niceName'"></select>
			</div>
			<div>
				Choices:
				<ul class="choices" data-bind="template: {
					name: 'choice-1_n_2',
					foreach: multiplechoice.choices
				}">
					<li><button data-bind="click:addChoice">Add a choice</button></li>
				</ul>
			</div>
		</script>

		<script type="text/x-jquery-tmpl" id="m_n_2">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum marks:',property:multiplechoice.minMarks, type: 'number', max:multiplechoice.maxMarks }
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum marks:',property:multiplechoice.maxMarks, type: 'number', min:multiplechoice.minMarks}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Shuffle order of choices?', property:multiplechoice.shuffleChoices}
				}"></div>
				<label>Selection type:</label><select data-bind="options: multiplechoice.displayTypes['m_n_2'], value: multiplechoice.displayType, optionsText: 'niceName'"></select>
				<div data-bind="fadeVisible: multiplechoice.displayType().name!='dropdown',
				template: {
					name: 'property',
					templateOptions: {label:'Number of display columns:',property:multiplechoice.displayColumns, type: 'number'}
				}"></div>
			</div>
			<div>
				Choices:
				<ul class="choices" data-bind="template: {
					name: 'choice-1_n_2',
					foreach: multiplechoice.choices
				}">
					<li><button data-bind="click:addChoice">Add a choice</button></li>
				</ul>
			</div>
		</script>
	
		<script type="text/x-jquery-tmpl" id="choice-1_n_2">
			<li class="choice">
				<button class="remove" data-bind="click:remove"></button>
				<span>
					<input type="text" data-bind="value:content, valueUpdate:'input'"/>
				</span>
				<span>
					<label>Marks:</label>
					<input type="number" data-bind="value:marks, valueUpdate:'input'"/>
				</span>
				<span>
					<label>Distractor Message:</label>
					<input type="text" data-bind="value:distractor, valueUpdate:'input'"/>
				</span>
			</li>
		</script>
	
		<script type="text/x-jquery-tmpl" id="m_n_x">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum marks:',property:multiplechoice.minMarks, type: 'number', max:multiplechoice.maxMarks }
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum marks:',property:multiplechoice.maxMarks, type: 'number', min:multiplechoice.minMarks}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum answers:',property:multiplechoice.minAnswers, type:'number', max:multiplechoice.maxAnswers}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum answers:',property:multiplechoice.maxAnswers, type:'number', min:multiplechoice.minAnswers}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Shuffle order of choices?', property:multiplechoice.shuffleChoices}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Shuffle order of answers?', property:multiplechoice.shuffleAnswers}
				}"></div>
				<label>Selection type:</label><select data-bind="options: multiplechoice.displayTypes.m_n_x, value: multiplechoice.displayType, optionsText: 'niceName'"></select>
			</div>
			<div class="matrix">
				<label>Marking matrix:</label>
				<table class="multiplechoice">
					<thead>
						<tr>
							<td/>
							{{each multiplechoice.answers()}}
								<th>
									<input type="text" data-bind="value:$value.content, valueUpdate:'input'">
									<button class="remove" data-bind="click:function(){removeAnswer($value)}"></button>
								</th>
							{{/each}}
							<td>
								<button data-bind="click:addAnswer">Add Answer</button>
							</td>
						</tr>
					</thead>
					<tbody data-bind="template: {
						name: 'choice-m_n_x',
						foreach: multiplechoice.choices
					}">
						<tr><td><button data-bind="click:addChoice">Add Choice</button></td></tr>
					</tbody>
				</table>
			</div>
		</script>
	
		<script type="text/x-jquery-tmpl" id="choice-m_n_x">
			<tr>
				<th>
					<input type="text" data-bind="value:content, valueUpdate:'input'"/>
					<button class="remove" data-bind="click:remove"></button>
				</th>
				{{each answers()}}
					<td>
						<input class="mark" type="number" data-bind="value:$value.marks, valueUpdate:'input'"/>
					</td>
				{{/each}}
			</tr>
		</script>

		<script type="text/x-jquery-tmpl" id="ruleset">
			<li class="ruleset">
				<input type="text" data-bind="value:name, valueUpdate: 'afterkeydown'"/>: <div data-bind="listbox:sets, rulesetcomplete: allsets"></div>
				<button class="remove" data-bind="click:remove"></button>
			</li>
		</script>

		<script type="text/x-jquery-tmpl" id="variable">
			<tr class="variable dict">
				<td><span class="handle"></span></td>
				<td><div><input type="text" class="name" data-bind="value:name, valueUpdate: 'afterkeydown', event: {keyup: function(d,e){if(e.which==13){ $(e.target).parents('.variable').find('.def').focus();} } }"/> = </div></td>
				<td><div><input class="def" type="text" data-bind="value:definition, valueUpdate: 'afterkeydown', event: {keyup: function(d,e){if(e.which==13){ $parent.addVariable($parent,e,$parent.variables.indexOf(this)+1); } } }"/></div></td>
				<td class="value"><div><span class="value" data-bind="css: {error: error().length>0}, text: display, mathjax: value"></span></div></td>
				<td><div><button class="remove" data-bind="click:remove"></button></div></td>
			</tr>
		</script>

		<script type="text/x-jquery-tmpl" id="function">
			<li class="function">
				<div data-bind="foldlist: $data, label: name, show:true">
					<div class="properties">
						<div data-bind="template: {
							name: 'property',
							templateOptions: {property:name,label: 'Name:'}
						}"></div>
						<div class="parameters">
							<label>Parameters:</label>
							<table class="list">
								<thead data-bind="visible: parameters().length>0">
									<th>Name</th>
									<th>Type</th>
									<th></th>
								</thead>
								<tbody data-bind="template:{
									name:'parameter',
									foreach: parameters,
									beforeRemove: function(elem) { $(elem).find('td>div').slideUp(150,function() {console.log($(this));$(this).remove()}) },
									afterAdd: function(elem) { $(elem).find('td>div').hide().slideDown(150).end().find('.name').focus(); },
								}"></tbody>
							</table>
							<button class="addparameter" data-bind="click:addParameter, text: parameters().length ? 'Add another parameter' : 'Add a parameter'"></button>
						</div>
						<div>
							<label>Output type: </label>
							<select data-bind="options: types, value:type"></select>
						</div>
						<div>
							<label>Language:</label>
							<select data-bind="options: languages, value: language"></select>
						</div>
						<div class="definition">
							<label>Definition:</label>
							<textarea data-bind="value: definition, valueUpdate: 'afterkeydown'"></textarea>
						</div>
					</div>
				</div>
			</li>
		</script>

		<script type="text/x-jquery-tmpl" id="parameter">
			<tr>
				<td><div><input data-bind="value: name"/></div></td>
				<td><div><select data-bind="options: $parent.types, value: type"></select></div></td>
				<td><div><button class="remove" data-bind="click: remove"></div></button>
			</tr>
		</script>

	    {% endverbatim %}
	
	        <div>
	            <div id="controls">
	                <div class="controlbox" id="author">
	                Author: {{ object.author.first_name }} {{ object.author.last_name }} ({{ object.author.username }})
	                </div>
	                <div class="controlbox" id="buttons">
	                    Download: 
	                    <a href="{% url question_download object.pk object.slug %}">standalone .zip</a>,
	                    <a href="{% url question_download object.pk object.slug %}?scorm">SCORM package</a>,
	                    <a href="{% url question_source object.pk object.slug %}">source</a>
	                </div>
	                <div class="controlbox" id="admin">
	                    <button id="preview" data-bind="click: showPreview">Test Run</button>
	                    <a id="delete" href="{% url question_delete object.pk object.slug %}"><img src="{{STATIC_URL}}images/delete.png"/> Delete</a>
	                    <a id="copy" href="{% url question_copy object.pk object.slug %}">Make a Copy</a>
	                </div>
	            </div>
				<div id="editor" data-bind="template: 'questionTemplate'"></div>
			</div>
		{% else %}
			<div>You are not permitted to view this question</div>
		{% endif %}

{% endblock content %}

