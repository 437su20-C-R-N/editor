{% extends "layout.html" %}
{% load verbatim %}

{% block head %}
    {{ block.super }}

    <!-- MathJax -->
    <script src="https://d3eoax9i5htok0.cloudfront.net/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
          MathJax.Hub.Config({
            extensions: ['tex2jax.js',"TeX/AMSmath.js","TeX/AMSsymbols.js"],
            tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
            jax: ["input/TeX","output/HTML-CSS"],
            displayAlign: "center",
            displayIndent: "0.1em",
            showProcessingMessages: false
          });
    </script>

    <!-- jQuery -->
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/jquery-ui.css">
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.oembed.js"></script>

    <!-- knockout -->
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/knockout.js"></script>

    <!-- jstextile -->
    <script type="text/javascript" src="{{ STATIC_URL }}js/textile.js"></script>

    <!-- write maths, see maths -->
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/writemaths.css">
    <script type="text/javascript" src="{{ STATIC_URL }}js/jme.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/writemaths.js"></script>

    <!-- exam parser -->
    <script type="text/javascript" src="{{ STATIC_URL }}js/examparser.js"></script>

    <!-- editor -->
    <script src="{{ STATIC_URL }}js/editor.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}js/question-editor.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/editor.css">
{% endblock head %}

{% block content %}
    <div id="fallback-form">
        <h2>{{ object.name }}</h2>

        {% if error %}<p><strong>{{ error }}</strong></p>{% endif %}

        <form action="{% url question_edit object.slug %}" method="post" id="edit-form">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="submit" value="Submit" />
        </form>
    </div>

    {% verbatim %}
		<script type="text/x-jquery-tmpl" id="examTemplate">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Exam name:',property:name}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Duration (minutes):',property:duration, type:'number',min:0}
				}"></div>
				<div data-bind="template: {
					name: 'percentproperty',
					templateOptions: {label:'Pass threshold (percent):',property:percentPass}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label: 'Shuffle questions?',property:shuffleQuestions}
				}"></div>
			</div>
			{{wrap(this,{label:"Navigation"}) folder}}
				<div>
					<div class="properties">
						<div data-bind="template: {
							name: 'booleanproperty',
							templateOptions: {label:'Allow user to regenerate questions?', property:allowregen}
						}"></div>
						<div data-bind="template: {
							name: 'booleanproperty',
							templateOptions: {label:'Allow move to previous question?', property:reverse}
						}"></div>
						<div data-bind="template: {
							name: 'booleanproperty',
							templateOptions: {label:'Allow jump to any question?', property:browse}
						}"></div>
						<div data-bind="template: {
							name: 'booleanproperty',
							templateOptions: {label: 'Show front page?',property:showfrontpage}
						}"></div>
					</div>
					<div data-bind="template: {
						name: 'event',
						data: onadvance
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: onreverse
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: onmove
					}"></div>
				</div>
			{{/wrap}}
			{{wrap(this,{label:"Timing"}) folder}}
				<div>
					<div data-bind="template: {
						name: 'event',
						data: timeout
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: timedwarning
					}"></div>
				</div>
			{{/wrap}}
			{{wrap(this,{label:"Feedback"}) folder}}
				<div class="properties">
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: { label:'Show actual mark?', property:showactualmark}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: { label:'Show total mark?', property:showtotalmark}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: { label:'Show answer state?', property:showanswerstate}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: { label:'Allow reveal answer?', property:allowreavealanswer}
					}"></div>
					<div data-bind="template: {
						name: 'percentproperty',
						templateOptions: { label:'Advice threshold (percent)', property:advicethreshold}
					}"></div>
				</div>
			{{/wrap}}
			{{wrap(this,{label:"Rulesets"}) folder}}
			<div class="rulesets">
				<ul class="editlist" data-bind="template:{
					name:'ruleset',
					foreach: rulesets,
					beforeRemove: function(elem) { $(elem).slideUp(150) },
					afterAdd: function(elem) { $(elem).hide().slideDown(150) }
				}"></ul>
				<button data-bind="click:addRuleset, text: rulesets().length ? 'Add another ruleset' : 'Add a ruleset'"></button>
			</div>
			{{/wrap}}
			<div class="questions fold">
				<div id="folder-header">Questions</div>
				<div id="folder">
					<div>
						<ol class="editlist" data-bind="template: {
							name: 'question',
							foreach: questions,
							beforeRemove: function(elem) { console.log($(elem).parents());$(elem).slideUp(150) },
							afterAdd: function(elem) { console.log('add');console.log(elem);$(elem).hide().slideDown(150) }
						}"></ol>
						<button data-bind="click:addQuestion,text:questions().length ? 'Add another question' : 'Add a question'"></button>
					</div>
				</div>
			</div>
		</script>

		<script type="text/x-jquery-tmpl" id="event">
			{{wrap(this,{label:niceName}) "#folder"}}
				<div>
				<div class="properties">
					<div>
						<label>Action: </label>
						<select data-bind="options: actions, value: action, optionsText: 'niceName'"></select>
					</div>
				</div>
				<div data-bind="fadeVisible:action().value!='none'">
					Message: 
					<div data-bind="writemaths: message"/>
				</div>
				</div>
			{{/wrap}}
		</script>

		<script type="text/x-jquery-tmpl" id="ruleset">
			<li class="ruleset">
				<input type="text" data-bind="value:name, valueUpdate: 'input'"/>: <div data-bind="listbox:sets, rulesetcomplete: allsets"></div>
				<button class="remove" data-bind="click:remove"></button>
			</li>
		</script>

		<script type="text/x-jquery-tmpl" id="questionTemplate">
				<div class="properties">
					<div data-bind="template: {
						name: 'property',
						templateOptions: {property:name,label:'Question name:'}
					}"></div>
				</div>

				<div style="margin-bottom:1em;" data-bind="writemaths:statement">
					Statement:
				</div>
				<div style="margin-bottom:1em;" data-bind="writemaths:advice">
					Advice:
				</div>
				{{wrap(this,{label:"Variables",show:true}) '#folder'}}
					<div>
						<ul class="editlist" data-bind="template:{
							name:'variable',
							foreach: variables,
							beforeRemove: function(elem) { $(elem).slideUp(150) },
							afterAdd: function(elem) { $(elem).hide().slideDown(150) }
						}"></ul>
						<button data-bind="click:addVariable, text: variables().length ? 'Add another variable' : 'Add a variable'"></button>
					</div>
				{{/wrap}}
				{{wrap(this,{label:"Parts",show:true}) '#folder'}}
					<div>
						<ol class="editlist" data-bind="template:{
							name: 'part',
							foreach: parts,
							beforeRemove: function(elem) { $(elem).slideUp(150) },
							afterAdd: function(elem) { $(elem).hide().slideDown(150) }
						}"></ol>
						<button data-bind="click:addPart, text: parts().length ? 'Add another part' : 'Add a part'"></button>
					</div>
				{{/wrap}}
		</script>

		<script type="text/x-jquery-tmpl" id="variable">
			<li class="variable dict">
				<input type="text" class="name" data-bind="value:name, valueUpdate: 'input'"/> = <input class="def" type="text" data-bind="value:definition, valueUpdate: 'input'"/>
				<button class="remove" data-bind="click:remove"></button>
			</li>
		</script>

		<script type="text/x-jquery-tmpl" id="part">
			<li class="part">
				<div data-bind="foldlist: this, label: type().niceName, show:true">
					<div class="properties">
						<div>
							<label>Part type: </label>
							<select data-bind="options: types, value:type, optionsText: 'niceName'"></select>
						</div>
						<div data-bind="fadeVisible: type().has_marks===true, template: {
							name: 'property',
							templateOptions: {label:'Marks:',property:marks, type:'number'}
						}"></div>
					</div>
					<div data-bind="visible: $data.parent==null || $data.parent.type().name!='gapfill' || $data.parent.steps().contains($data)">
						Prompt:
						<div data-bind="writemaths: prompt"></div>
					</div>
					<div style="margin-top:1em;" data-bind="template: type"></div>
					<div class="steps fold" data-bind="visible:parent==null">
						<div id="folder-header">Steps</div>
						<div id="folder">
							<div class="properties">
								<div data-bind="fadeVisible: steps().length>0, template: {
									name: 'property',
									templateOptions: {label:'Penalty for revealing steps (marks):',property:stepsPenalty, type:'number'}
								}"></div>
							</div>
							<ol class="editlist" data-bind="template:{
								name: 'part',
								foreach: steps,
								beforeRemove: function(elem) { $(elem).slideUp(150) },
								afterAdd: function(elem) { $(elem).hide().slideDown(150) }
							}"></ol>
							<button data-bind="click:addStep, text: steps().length ? 'Add another step' : 'Add a step'"></button>
						</div>
					</div>
				</div>
			</li>
		</script>
		
		<script type="text/x-jquery-tmpl" id="information">
			
		</script>

		<script type="text/x-jquery-tmpl" id="gapfill">
			<div class="gaps fold">
				<div id="folder-header">Gaps</div>
				<div id="folder">
					<ol class="editlist" data-bind="template:{
						name: 'part',
						foreach: gapfill.gaps,
						beforeRemove: function(elem) { $(elem).slideUp(150) },
						afterAdd: function(elem) { $(elem).hide().slideDown(150) }
					}"></ol>
					<button data-bind="click:addGap, text: gapfill.gaps().length ? 'Add another gap' : 'Add a gap'"></button>
				</div>
			</div>
		</script>

		<script type="text/x-jquery-tmpl" id="jme">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Correct answer:',property:jme.answer}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Answer simplification rules:',property:jme.answerSimplification}
				}"></div>
			</div>
			{{wrap(this,{label:'Checking accuracy'}) '#folder'}}
			<div class="properties">
				<div>
					<label>Checking type: </label>
					<select data-bind="options: jme.checkingTypes, value: jme.checkingType, optionsText:'niceName'"></select>
				</div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Checking accuracy:',property:jme.checkingType().accuracy, type:'number',min:0}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Points to check:',property:jme.vset.points, type:'number',min:0}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Checking range start:',property:jme.vset.start, type:'number',max:jme.vset.end}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Checking range end:',property:jme.vset.end, type:'number',min:jme.vset.start}
				}"></div>
			</div>
			{{/wrap}}

			{{wrap(this,{label:'Maximum length restriction'}) '#folder'}}
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum length:',property:jme.maxlength.length, type:'number',min:0}
				}"></div>
				<div data-bind="fadeVisible: jme.maxlength.length()>0">
					<div data-bind="template: {
						name:'percentproperty',
						templateOptions: {label:'Partial credit for long answer:',property:jme.maxlength.partialCredit}
					}"></div>
					<div>
						Warning message:
						<div data-bind="writemaths: jme.maxlength.message"></div>
					</div>
				</div>
			</div>
			{{/wrap}}

			{{wrap(this,{label:'Minimum length restriction'}) '#folder'}}
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum length:',property:jme.minlength.length, type:'number',min:0}
				}"></div>
				<div data-bind="fadeVisible: jme.minlength.length()>0">
					<div data-bind="template: {
						name:'percentproperty',
						templateOptions: {label:'Partial credit for short answer:',property:jme.minlength.partialCredit}
					}"></div>
					<div>
						Warning message:
						<div data-bind="writemaths: jme.minlength.message"></div>
					</div>
				</div>
			</div>
			{{/wrap}}
			{{wrap(this,{label:'Required strings'}) '#folder'}}
			<div class="properties">
				<div>
					<label>Required strings:</label>
					<div data-bind="listbox:jme.musthave.strings"></div>
				</div>
				<div data-bind="fadeVisible: jme.musthave.strings().length>0">
					<div data-bind="template: {
						name:'percentproperty',
						templateOptions: {label:'Partial credit for not using all required strings:',property:jme.musthave.partialCredit}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: {label:'Show required strings in warning?', property:jme.musthave.showStrings}
					}"></div>
					<div>
						Warning message:
						<div data-bind="writemaths: jme.musthave.message"></div>
					</div>
				</div>
			</div>
			{{/wrap}}
			{{wrap(this,{label:'Forbidden strings'}) '#folder'}}
			<div class="properties">
				<div>
					<label>Forbidden strings:</label>
					<div data-bind="listbox:jme.notallowed.strings"></div>
				</div>
				<div data-bind="fadeVisible: jme.notallowed.strings().length>0">
					<div data-bind="template: {
						name:'percentproperty',
						templateOptions: {label:'Partial credit for using forbidden strings:',property:jme.notallowed.partialCredit}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: {label:'Show forbidden strings in warning?', property:jme.notallowed.showStrings}
					}"></div>
					<div>
						Warning message:
						<div data-bind="writemaths: jme.notallowed.message"></div>
					</div>
				</div>
			</div>
			{{/wrap}}
		</script>

		<script type="text/x-jquery-tmpl" id="numberentry">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Correct answer:',property:numberentry.answer}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Must answer be an integer?', property:numberentry.integerAnswer}
				}"></div>
				<div data-bind="fadeVisible: numberentry.integerAnswer,
				template: {
					name:'percentproperty',
					templateOptions: {label:'Partial credit for non-integer answer:',property:numberentry.partialCredit}
				}"></div>
			</div>
		</script>

		<script type="text/x-jquery-tmpl" id="patternmatch">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Answer pattern:',property:patternmatch.answer}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Correct answer:',property:patternmatch.displayAnswer}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Must answer be in the correct case?', property:patternmatch.caseSensitive}
				}"></div>
				<div data-bind="
				fadeVisible:patternmatch.caseSensitive,
				template: {
					name:'percentproperty',
					templateOptions: {label:'Partial credit for answer not matching case:',property:patternmatch.partialCredit}
				}"></div>
			</div>
		</script>


		<script type="text/x-jquery-tmpl" id="1_n_2">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum marks:',property:multiplechoice.minMarks, type: 'number', max:multiplechoice.maxMarks }
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum marks:',property:multiplechoice.maxMarks, type: 'number', min:multiplechoice.minMarks}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Shuffle order of choices?', property:multiplechoice.shuffleChoices}
				}"></div>
				<label>Selection type:</label><select data-bind="options: multiplechoice.displayTypes['1_n_2'], value: multiplechoice.displayType, optionsText: 'niceName'"></select>
			</div>
			<div>
				Choices:
				<ul class="choices" data-bind="template: {
					name: 'choice-1_n_2',
					foreach: multiplechoice.choices
				}">
					<li><button data-bind="click:addChoice">Add a choice</button></li>
				</ul>
			</div>
		</script>
		<script type="text/x-jquery-tmpl" id="m_n_2">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum marks:',property:multiplechoice.minMarks, type: 'number', max:multiplechoice.maxMarks }
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum marks:',property:multiplechoice.maxMarks, type: 'number', min:multiplechoice.minMarks}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Shuffle order of choices?', property:multiplechoice.shuffleChoices}
				}"></div>
				<label>Selection type:</label><select data-bind="options: multiplechoice.displayTypes['m_n_2'], value: multiplechoice.displayType, optionsText: 'niceName'"></select>
				<div data-bind="fadeVisible: multiplechoice.displayType().name!='dropdown',
				template: {
					name: 'property',
					templateOptions: {label:'Number of display columns:',property:multiplechoice.displayColumns, type: 'number'}
				}"></div>
			</div>
			<div>
				Choices:
				<ul class="choices" data-bind="template: {
					name: 'choice-1_n_2',
					foreach: multiplechoice.choices
				}">
					<li><button data-bind="click:addChoice">Add a choice</button></li>
				</ul>
			</div>
		</script>

		<script type="text/x-jquery-tmpl" id="choice-1_n_2">
			<li class="choice">
				<button class="remove" data-bind="click:remove"></button>
				<span>
					<input type="text" data-bind="value:content, valueUpdate:'input'"/>
				</span>
				<span>
					<label>Marks:</label>
					<input type="number" data-bind="value:marks, valueUpdate:'input'"/>
				</span>
				<span>
					<label>Distractor Message:</label>
					<input type="text" data-bind="value:distractor, valueUpdate:'input'"/>
				</span>
			</li>
		</script>

		<script type="text/x-jquery-tmpl" id="m_n_x">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum marks:',property:multiplechoice.minMarks, type: 'number', max:multiplechoice.maxMarks }
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum marks:',property:multiplechoice.maxMarks, type: 'number', min:multiplechoice.minMarks}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Minimum answers:',property:multiplechoice.minAnswers, type:'number', max:multiplechoice.maxAnswers}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Maximum answers:',property:multiplechoice.maxAnswers, type:'number', min:multiplechoice.minAnswers}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Shuffle order of choices?', property:multiplechoice.shuffleChoices}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label:'Shuffle order of answers?', property:multiplechoice.shuffleAnswers}
				}"></div>
				<label>Selection type:</label><select data-bind="options: multiplechoice.displayTypes.m_n_x, value: multiplechoice.displayType, optionsText: 'niceName'"></select>
			</div>
			<div class="matrix">
				<label>Marking matrix:</label>
				<table class="multiplechoice">
					<thead>
						<tr>
							<td/>
							{{each multiplechoice.answers()}}
								<th>
									<input type="text" data-bind="value:$value.content, valueUpdate:'input'">
									<button class="remove" data-bind="click:function(){removeAnswer($value)}"></button>
								</th>
							{{/each}}
							<td>
								<button data-bind="click:addAnswer">Add Answer</button>
							</td>
						</tr>
					</thead>
					<tbody data-bind="template: {
						name: 'choice-m_n_x',
						foreach: multiplechoice.choices
					}">
						<tr><td><button data-bind="click:addChoice">Add Choice</button></td></tr>
					</tbody>
				</table>
			</div>
		</script>

		<script type="text/x-jquery-tmpl" id="choice-m_n_x">
			<tr>
				<th>
					<input type="text" data-bind="value:content, valueUpdate:'input'"/>
					<button class="remove" data-bind="click:remove"></button>
				</th>
				{{each answers()}}
					<td>
						<input class="mark" type="number" data-bind="value:$value.marks, valueUpdate:'input'"/>
					</td>
				{{/each}}
			</tr>
		</script>

		<!-- Property Inputs -->

		<script type="text/x-jquery-tmpl" id="percentproperty">
			<label>${$item.label}</label>
			<span class="display" data-bind="text: $item.property()+'%'"></span>
			<input data-bind="
					value: $item.property, 
					valueUpdate: 'input'" 
				type="range"
				step="5"
				min="0"
				max="100"
			/>
		</script>

		<script type="text/x-jquery-tmpl" id="booleanproperty">
			<label>${$item.label}</label>
			<input data-bind="checked: $item.property" type="checkbox"/>
		</script>

		<script type="text/x-jquery-tmpl" id="property">
			<label>${$item.label}</label>
			{{if $item.type=='checkbox'}}
				<input data-bind="checked: $item.property" type="checkbox"/>
			{{else}}
				<input data-bind="
						value: $item.property, 
						valueUpdate: 'input'" 
					type="${$item.type || 'text'}" 
					{{if $item.min!==undefined}} min="${$item.min}" {{/if}}
					{{if $item.max!==undefined}} max="${$item.max}" {{/if}}
				/>
			{{/if}}
		</script>

		<script type="text/x-jquery-tmpl" id="folder">
			<div class="fold {{if !$item.show}}folded{{/if}}">
				<div id="folder-header">${$item.label}</div>
				<div id="folder">{{html $item.html}}</div>
			</div>
		</script>


		<div id="editor" data-bind="template: 'questionTemplate'">
		</div>
    {% endverbatim %}

{% endblock content %}

{% block sidebar %}
    <button id="preview" type="button">Question preview</button>
    <div id="preview-message"></div>
{% endblock sidebar %}

{% block javascripts %}
    {{ block.super }}
    <script type="text/javascript">
    {% autoescape off %}
    var questionJSON = {{ question_JSON }};
    {% endautoescape %}
    (function() {
        if (!window.Editor) {
            window.Editor = {};
        }
        window.Editor['exam_preview_url'] = '{% url exam_preview object.slug %}';
    })();
    </script>
{% endblock javascripts %}
