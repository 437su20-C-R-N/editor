{% extends "layout.html" %}

{% block content %}

    {% if user.is_authenticated %}
        <div class="controlbox" id="admin">
            <a id="new" href="{% url exam_new %}">Create a new exam</a>
            <form action="{% url exam_upload %}" method="post" id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <a href="" id="upload">Upload an exam</a>
                <div class="upload">
                    <input type="file" name="file" multiple value="yo"/>
                </div>
            </form>
        </div>
    {% endif %}

    <div>
        <div id="searchBox" data-bind="with: search">
            <label for="search_query">Search for exams called: </label>
            <input role="search" id="search_query" type="text" name="examSearch" class="search" data-bind="
                value: query, 
				valueUpdate: 'afterkeydown',
				css: {loading: searching}
            "/>

			<label for="search_author"> by author: </label>
			<input id="search_author" type="text" class="search" size="30" data-bind="
                value: author,
                valueUpdate: 'afterkeydown change',
                autocomplete: '{% url user_search %}', 
				autocompleteCallback: function(user) { return {label: user.username+' ('+user.name+')', value: user.username} },
				click: clearMine
			"/>
			{% if user.is_authenticated %}(mine only <input type="checkbox" data-bind="checked: mine"/>){% endif %}

			<div data-bind="with: results">
				<div id="pagination" data-bind="visible: pages().length>0">
					Page:
					<button class="move previous" data-bind="click: prevPage"></button><span data-bind="text: pageText"></span><button class="move next" data-bind="click: nextPage"></button>
				</div>
                <div class="results">
					<table id="exam-list" data-bind="visible: all().length>0">
							<col span="1" class="name"/>
							<col span="1" class="author"/>
							<col span="1" class="last_modified"/>
							<col span="1" class="admin"/>
						<thead>
							<th>Name</th>
                            <th>Author</th>
                            <th>Last Modified</th>
						</thead>
                        <tbody class="results editlist big" data-bind="foreach: {
                            data: pages()[page()-1],
                        }">
                            <tr class="result exam">
								<td>
									<a data-bind="attr: {href: url}, text: name"></a>
									<div class="description" data-bind="visible: metadata.description.length>0, html: $(metadata.description).text(), mathjax: true"></div>
								</td>
                                <td><span data-bind="text: author"></span></td>
								<td><span data-bind="calendarTime: last_modified"></span></td>
                                <td class="admin">
                                    <a class="preview" data-bind="attr: {href: url+'preview/'}" target="_blank" title="Test run"></a>
                                    <a class="copy" data-bind="attr: {href: url+'copy/'}" title="Make a copy"></a>
                                    <a class="delete" data-bind="visible: canEdit, attr: {href: url+'delete/'}, click: function() {$parent.deleteExam(this) }" title="Delete"></a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
					<div class="none" data-bind="visible: all().length==0, text: $parent.searching() ? 'Loading results...' : 'No exams found.'"></div>
					<div class="error" data-bind="visible: error().length>0, html: error"></div>
				</div>
			</div>
        </div>
    </div>
    
    <script type="text/html" id="exam">
    </script>
 
{% endblock content %}

{% block javascripts %}
	{{block.super}}
	<script type="text/javascript" src="{{ STATIC_URL }}js/exam/index.js"></script>
{% endblock javascripts %}

{% block stylesheets %}
	{{ block.super }}
    <link href="{{ STATIC_URL }}css/index.css" type="text/css" rel="stylesheet" />
    <link href="{{ STATIC_URL }}css/exam/index.css" type="text/css" rel="stylesheet" />
{% endblock stylesheets %}
