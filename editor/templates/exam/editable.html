{% extends "exam/edit.html" %}
{% load verbatim %}
{% load user_link %}
{% load icon %}
{% load helplink %}
{% load editor_controls %}

{% block editable_message %}You can edit this exam.{% endblock %}

{% block editor %}
    <div class="tab-content">

        <!-- Settings tab -->
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='settings'}">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-8">
                        <div class="form-group name">
                            <label>Name</label>
                            <input class="form-control input-lg" data-bind="textInput: name">
                        </div>
                        <div class="form-group description">
                            <label>Description</label>
                            <div data-bind="writemaths: description"></div>
                            <p class="help-block">
                                {% helplink 'http://numbas-editor.readthedocs.org/en/latest/question-reference.html#description' subject='the description field' %}
                                Describe what this exam assesses, or how it is going to be used.
                            </p>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <h3 class="panel-title">Metadata</h3>
                            </div>
                            <div class="panel-body">
                                <div class="form-group">
                                    <label><span class="glyphicon glyphicon-user"></span> Author</label>
                                    <div class="media">
                                        <div class="media-left">
                                            {% user_thumbnail object.editoritem.author 40 36 %}
                                        </div>
                                        <div class="media-body">
                                            <p class="form-control-static">{% user_link object.editoritem.author %}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label><span class="glyphicon glyphicon-briefcase"></span> Project</label>
                                    <p class="form-control-static"><a target="_blank" href="{% url 'project_index' object.editoritem.project.pk %}">{{object.editoritem.project.name}}</a></p>
                                </div>
                                <div class="form-group">
                                    <label><span class="glyphicon glyphicon-copyright-mark"></span> Licence</label>
                                    <select class="form-control" data-bind="options: Editor.licences, value: licence, optionsText: 'short_name', optionsCaption: 'None specified'"></select>
                                    <p class="help-block">
                                        <small data-bind="visible: licence, with: licence"><a target="_blank" data-bind="visible: url, attr:{href:url}">Licence information</a></small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <nav>
                    <ul class="pager">
                        <li class="next" data-bind="css: {ready: section_completed.settings}">
                            <a title="Proceed to the next section" href="#" data-bind="click: setTab('questions')">Questions →</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </section>

        <!-- Questions -->
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='questions'}">
            <div class="questions row">
                <div class="col-sm-6">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h4 class="panel-title">Questions in this exam</h4>
                        </div>
                        <div class="panel-body">
                            <form class="form-horizontal">
                                {% with form_label_class='col-sm-6' form_control_class='col-sm-6' %}
                                {% booleanproperty 'shuffleQuestions' 'Shuffle questions?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-shuffle-questions' %}
                                <div data-bind="fadeVisible: shuffleQuestions">
                                    {% booleanproperty 'allQuestions' 'Use all questions?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-use-all-questions' %}
                                </div>
                                <div data-bind="fadeVisible: !allQuestions()">
                                    {% property 'pickQuestions' 'Number of questions to display' min=0 max='questions().length' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-number-of-questions-to-display' %}
                                </div>
                                {% endwith %}
                            </form>
                        </div>
                        <ul class="list-group" data-bind="
                            sortable: {
                                template: 'question', 
                                data: questions, 
                                afterMove: dropQuestion,
                                options: {handle: '.handle', placeholder: 'placeholder'}
                            }
                            ">
                        </ul>
                    </div>
                </div>
                <div class="col-sm-6">
                    <ul class="nav nav-tabs" data-bind="foreach: questionTabs">
                        <li data-bind="css: {active: $root.currentQuestionTab() == $data}">
                            <a href="#" data-bind="click: $root.currentQuestionTab, text: title"></a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentQuestionTab().id)=='mine'}">
                            <ul class="results editlist big" data-bind="
                                template: {
                                    name: 'questionResult',
                                    foreach: recentQuestions,
                                }
                            "></ul>
                        </div>
                        <div class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentQuestionTab().id)=='basket'}">
                            <ul class="results editlist big" data-bind="
								visible: basketQuestions().length>0,
                                template: {
                                    name: 'questionResult',
                                    foreach: basketQuestions,
                                }
                            "></ul>
							<div data-bind="visible: basketQuestions().length==0">
								<p class="nothing-here">There's nothing in your basket at the moment. Find questions you'd like to use, and click on the basket icon. They'll show up here so you can easily add them to this exam.</p>
							</div>
                        </div>
                        <div class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentQuestionTab().id)=='search'}">
                            <form class="form-horizontal" data-bind="submit: search.submit">
                                <div class="control-group">
                                    <label for="questionsearch">
                                        <span class="control-label">Search for questions:</span>
                                        <div class="controls">
                                            <div class="input-append">
                                                <input type="text" id="questionsearch" class="search" placeholder="Topic or question name" data-bind="
                                                    value: search.query, 
                                                    valueUpdate: 'afterkeydown'
                                                "/>
                                                <span class="add-on"><button type="submit" class="search" data-bind="css: {loading: search.searching}"></button></span>
                                            </div>
                                        </div>
                                    </label>
                                    <label for="questionsearchtags">
                                        <span class="control-label">Filter by tags:</span>
                                        <div class="controls">
                                            <input type="text" id="questionsearchtags" class="search" placeholder="Tags separated by commas" data-bind="
                                                value: search.tags, 
                                                valueUpdate: 'afterkeydown'
                                            "/>
                                        </div>
                                    </label>
                                </div>
                            </form>
                            <div class="searchBox">
                                <ul class="results editlist big" data-bind="
                                    template: {
                                        name: 'questionResult',
                                        foreach: search.results.all,
                                    }
                                "></ul>
                            </div>
                        </div>
                    </div>
                </div>
			</div>
		</section>

        <!-- Navigation -->
        <section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='navigation'}">
            <form class="form-horizontal">
                {% booleanproperty 'allowregen' 'Allow user to regenerate questions?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-user-to-regenerate-questions' %}
                {% booleanproperty 'reverse' 'Allow move to previous question?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-move-to-previous-question' %}
                {% booleanproperty 'browse' 'Allow to jump to any question?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-jump-to-any-question' %}
                {% booleanproperty 'showfrontpage' 'Show front page?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-front-page' %}
                {% booleanproperty 'showresultspage' 'Show results page?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-results-page' %}
                {% booleanproperty 'preventleave' 'Confirm before leaving the exam while it\'s running?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-confirm-before-leaving-the-exam-while-it-s-running' %}
                {% exam_event 'onleave' 'On leaving a question' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-on-leaving-a-question' %}
            </form>
        </section>

        <!-- Timing -->
        <section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='timing'}">
            <form class="form-horizontal">
                {% property 'duration' 'Exam duration (minutes)' min=0 help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-exam-duration' %}
                {% booleanproperty 'allowPause' 'Allow pausing?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-pausing' %}
                {% exam_event 'timeout' 'On timeout' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-on-timeout-event' %}
                {% exam_event 'timedwarning' '5 minutes before timeout' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-minutes-before-timeout-event' %}
            </form>
        </section>

        <!-- Feedback -->
        <section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='feedback'}">
            <form class="form-horizontal">
                {% booleanproperty 'showactualmark' 'Show current score?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-current-score' %}
                {% booleanproperty 'showtotalmark' 'Show maximum score?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-maximum-score' %}
                {% booleanproperty 'showanswerstate' 'Show answer state?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-answer-state' %}
                {% booleanproperty 'allowrevealanswer' 'Allow reveal answer?' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-reveal-answer' %}
                {% percentproperty 'advicethreshold' 'Advice threshold' help_url='http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-advice-threshold' %}
            </form>
        </section>

        <!-- Access -->
        <section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='access'}">
            <div class="panel panel-warning" data-bind="visible: !published() && !all_sections_completed()">
                <div class="panel-heading">
                    <h3 class="panel-title">Publish</h3>
                </div>
                <div class="panel-body">
                    <p>At the moment, access to this exam is restricted to members of the project this exam belongs to and any other users you've explicitly granted access to.</p>
                    <p>Complete each of the following tasks before you publish this exam:</p>
                    <ul class="list-unstyled" data-bind="foreach: mainTabs">
                        <li data-bind="visible: $root.section_completed[id]!==undefined">
                        <h4><a href="#" data-bind="text: title, click: $root.setTab(id), css: {'text-success': $root.section_completed[id], 'text-danger': !ko.unwrap($root.section_completed[id])}"></a></h4>
                            <ul data-bind="foreach: $root.section_tasks[id]">
                                <li data-bind="css: {'text-success': done, 'text-danger': !done()}">
                                    <span class="glyphicon" data-bind="css:{'glyphicon-ok':done, 'glyphicon-alert':!done()}"></span>
                                    <span data-bind="text: text"></span> 
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-warning" data-bind="visible: !published() && all_sections_completed()">
                <div class="panel-heading">
                    <h3 class="panel-title">Publish</h3>
                </div>
                <div class="panel-body">
                    <p>At the moment, this exam is restricted to members of the project this exam belongs to and any other users you've explicitly granted access to.</p>
                    <p>Publish your exam so that others can see it.</p>
                    <form method="POST" action="{% url 'item_publish' object.editoritem.pk %}">
                        <button class="btn btn-danger" type="submit">Publish</button>
                        {% csrf_token %}
                    </form>
                </div>
            </div>
            <div class="panel panel-success" data-bind="visible: published">
                <div class="panel-heading">
                    <h3 class="panel-title">Publish</h3>
                </div>
                <div class="panel-body">
                    <p>This exam has been published to the public exam database.</p>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">Access rights</h3>
                </div>
                <table class="table">
                    <thead>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="glyphicon glyphicon-globe"></span> Public access</td>
                            <td>
                                <select class="form-control" data-bind="visible: published, value: public_access, options: access_options, optionsText:'text',optionsValue:'value'"></select>
                                <em data-bind="visible: !ko.unwrap(published)">This exam has not been published</em>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>{% user_thumbnail object.editoritem.author 20 15 %} {% user_link object.editoritem.author new_window=True%}</td>
                            <td>
                                Owner
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><span class="glyphicon glyphicon-briefcase"></span> Members of <a href="{% url 'project_index' object.editoritem.project.pk %}">{{object.editoritem.project.name}}</a></td>
                            <td>
                                Access granted by project owner
                            </td>
                            <td></td>
                        </tr>
                        <!-- ko foreach: {data: access_rights, afterAdd: Editor.afterAdd} -->
                        <tr>
                            <td data-bind="html: link"></td>
                            <td>
                                <select class="form-control" data-bind="hasfocus: true, value: access_level, options: access_options, optionsText:'text',optionsValue:'value'"></select>
                            </td>
                            <td>
                                <button type="button" class="btn btn-link" data-bind="click: remove" title="Remove this user's access"><span class="glyphicon glyphicon-remove text-danger"></span></button>
                            </td>
                        </tr>
                        <!-- /ko -->
                    </tbody>
                </table>
                <div class="panel-body">
                    <label>Give access to</label>
                    <input class="form-control" id="search_author" type="text" placeholder="Full name or username" size="30" data-bind="
                        value: userAccessSearch,
                        autocomplete: '{% url 'user_search' %}', 
                        autocompleteCallback: function(user) { return {label: user.name, value: user.name} },
                        autocompleteSelect: addUserAccess
                        "
                    />
                </div>
            </div>


            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">Access Links</h3>
                </div>
                <div class="panel-body">
                    <p>Share these links to give automatic access to this exam. Be careful about who you share these with - whoever clicks on the link will be given access.</p>
                </div>
                <ul class="share-links list-group">
                    <li class="list-group-item">
                        <label>View</label>
                        <input class="share-link form-control" readonly value="{{SITE_ROOT}}{% url 'share_exam' 'view' object.editoritem.share_uuid_view %}">
                    </li>
                    <li class="list-group-item">
                        <label>Edit</label>
                        <input class="share-link form-control" readonly value="{{SITE_ROOT}}{% url 'share_exam' 'edit' object.editoritem.share_uuid_edit %}">
                    </li>
                </ul>
            </div>

            <nav>
                <ul class="pager">
                    <li class="previous">
                        <a title="Back to the previous section" href="#" data-bind="click: setTab('advice')">← Advice</a>
                    </li>
                </ul>
            </nav>
        </section>
    </div>

	{% verbatim %}

	<script type="text/html" id="question">
		<li class="question list-group-item clearfix">
            <span class="handle btn btn-link btn-lg pull-left"><span class="glyphicon glyphicon-move"></span></span>
			<div class="controls pull-right">
                <a class="preview btn btn-link" data-bind="attr: {href: previewURL()}" target="_blank" title="Preview this question"><span class="glyphicon glyphicon-play text-success"></span></a>
                <button type="button" class="copy btn btn-link" data-bind="click:replaceWithCopy" title="Replace this question with a copy"><span class="glyphicon glyphicon-duplicate text-warning"></span></button>
                <button type="button" class="delete btn btn-link" data-bind="click:remove" title="Delete this question"><span class="glyphicon glyphicon-remove text-danger"></span></button>
			</div>
            <div class="title">
                <strong class="number" data-bind="text: ($index()+1)+'.'"></strong>
				<a data-bind="attr:{href: url}, text: name, mathjax: name" target="_blank"></a>
			</div>
			<div class="description" data-bind="visible: description.length>0, html: description, mathjax: true"></div>
		</li>
	</script>

	<script type="text/html" id="questionResult">
		<li class="question question-result list-group-item">
            <span class="handle btn btn-link pull-left" data-bind="click: add"><span class="glyphicon glyphicon-plus"></span></span>
			<div class="controls pull-right">
                <a class="preview btn btn-link" data-bind="attr: {href: previewURL()}" target="_blank" title="Preview this question"><span class="glyphicon glyphicon-play text-success"></span></a>
			</div>
			<div class="details">
				<div class="title">
					<a data-bind="attr:{href: url}, text: name, mathjax: name" target="_blank"></a>
				</div>
				<div class="author">
					(<span data-bind="text: author"></span>)
				</div>
			</div>
			<div class="description" data-bind="visible: description.length>0, html: description, mathjax: true"></div>
		</li>
	</script>
	{% endverbatim %}
{% endblock editor %}

{% block old_editor %}
	{{ block.super }}
	{% include "editable.html" %}

	<div class="tab-content">
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='settings'}">





			<div class="row-fluid section">
				<label>
					<h4>Exam Name <span data-bind="template: {name: 'helplink', data: {url: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-exam-name', topic: 'exam name'}}"></span></h4>
					<input class="input-block-level" id="exam-name" data-bind="value: name, valueUpdate: 'afterkeydown'" type="text"/>
				</label>
			</div>
			<div class="row-fluid section">
				<div class="span8">
					<p><span class="exam-author">Exam Author:</span> {% user_link object.editoritem.author %}</p>
					<p class="editable-message">You can edit this exam.</p>
                    <form class="form-inline">
                        <div class="control-group">
                            <label>
                                <span class="control-label">
                                    Licence: 
                                    <span data-bind="template: {name: 'helplink', data: {topic: 'licence', url: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-licence'}}"></span>
                                </span>
                                <span class="controls">
                                    <select data-bind="options: Editor.licences, value: licence, optionsText: 'short_name', optionsCaption: 'None specified'"></select>
                                    <span data-bind="visible: licence, with: licence">
                                        <a target="_blank" data-bind="visible: url, attr:{href:url}">Licence information</a>
                                    </span>
                                </span>
                            </label>
                        </div>
                    </form>
				</div>
			</div>
            <div class="row-fluid section">
                <div class="span7">
                    <label for="description"><h4>Description  <span data-bind="template: {name: 'helplink', data: {url: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-description', topic: 'description'}}"></span></h4></label>
                    <div id="description" data-bind="writemaths: description"></div>
                    <label for="authors-notes"><h4>Author's Notes  <span data-bind="template: {name: 'helplink', data: {url: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-author-s-notes', topic: 'author\'s notes'}}"></span></h4></label>
                    <div id="authors-notes" data-bind="writemaths: notes"></div>
                </div>
				<div class="span4">
					<h4>Options</h4>
                    <form class="form-horizontal">
						<div class="control-group">
							<label>
								<span class="control-label">
									Interface theme
									<span data-bind="template: {name: 'helplink', data: {url: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-theme'}}"></span>
								</span>
								<div class="controls">
                                    <select data-bind="options: Editor.themes, value: theme, optionsText: 'name'"></select>
                                    <div class="upload-theme"><a href="{% url 'theme_new' %}">Upload a new theme</a></div>
								</div>
							</label>
						</div>
						<div class="control-group">
							<label>
								<span class="control-label">
									Interface language
									<span data-bind="template: {name: 'helplink', data: {url: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-interface-language'}}"></span>
								</span>
								<div class="controls">
									<select data-bind="options: Editor.locales, value: locale, optionsValue: 'code', optionsText: 'name'"></select>
								</div>
							</label>
						</div>
                        <div class="control-group" data-bind="template: {
                            name: 'percentproperty',
                            data: {label:'Pass threshold (percent):',property:percentPass, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-pass-threshold'}
                        }"></div>
                    </form>
                </div>
			</div>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='navigation'}">
			<form class="form-horizontal">
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: {label:'Allow user to regenerate questions?', property:allowregen, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-user-to-regenerate-questions'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: {label:'Allow move to previous question?', property:reverse, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-move-to-previous-question'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: {label:'Allow jump to any question?', property:browse, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-jump-to-any-question'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: {label: 'Show front page?',property:showfrontpage, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-front-page'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: {label: 'Show results page?',property:showresultspage, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-results-page'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: {label: 'Confirm before leaving the exam while it\'s running?',property:preventleave, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-confirm-before-leaving-the-exam-while-it-s-running'}
				}"></div>
				<div data-bind="template: {
					name: 'event',
					data: onleave
				}"></div>
			</form>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='timing'}">
			<form class="form-horizontal">
				<div class="control-group" data-bind="template: {
					name: 'numberproperty',
					data: {label:'Exam duration (minutes):',property:duration, type:'number',min:0, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-exam-duration'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: {label:'Allow pausing?',property:allowPause, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-pausing'}
				}"></div>
				<div data-bind="template: {
					name: 'event',
					data: timeout
				}"></div>
				<div data-bind="template: {
					name: 'event',
					data: timedwarning
				}"></div>
			</form>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='feedback'}">
			<form class="form-horizontal">
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: { label:'Show current score?', property:showactualmark, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-current-score'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: { label:'Show maximum score?', property:showtotalmark, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-maximum-score'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: { label:'Show answer state?', property:showanswerstate, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-show-answer-state'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'booleanproperty',
					data: { label:'Allow reveal answer?', property:allowrevealanswer, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-allow-reveal-answer'}
				}"></div>
				<div class="control-group" data-bind="template: {
					name: 'percentproperty',
					data: { label:'Advice threshold (percent)', property:advicethreshold, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-advice-threshold'}
				}"></div>
			</form>
		</section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='questions'}">
			<div class="row-fluid">
			</div>
            <div class="questions row-fluid">
                <div class="span6">
                    <form class="form-horizontal">
                        <div class="control-group" data-bind="template: {
                            name: 'booleanproperty',
                            data: {label: 'Shuffle questions?',property:shuffleQuestions, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-shuffle-questions'}
                        }"></div>
                        <div class="control-group" data-bind="fadeVisible: shuffleQuestions, template: {
                            name: 'booleanproperty',
                            data: {label: 'Use all questions?',property: allQuestions, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-use-all-questions'}
                        }"></div>
                        <div class="control-group" data-bind="fadeVisible: !allQuestions(), template: {
                            name: 'numberproperty',
                            data: {label: 'Number of questions to display',property:pickQuestions, min: 0, max: questions().length, helpURL: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#term-number-of-questions-to-display'}
                        }"></div>
                    </form>
                    <ul class="questionList" data-bind="
                        sortable: {
                            template: 'question', 
                            data: questions, 
                            afterMove: dropQuestion,
                            options: {handle: '.handle', placeholder: 'placeholder'}
                        }
                        "></ul>
                </div>
                <div class="span6">
                    <ul class="nav nav-tabs" data-bind="foreach: questionTabs">
                        <li data-bind="css: {active: $root.currentQuestionTab() == $data}">
                            <a href="#" data-bind="click: $root.currentQuestionTab, text: title"></a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentQuestionTab().id)=='mine'}">
                            <ul class="results editlist big" data-bind="
                                template: {
                                    name: 'questionResult',
                                    foreach: recentQuestions,
                                }
                            "></ul>
                        </div>
                        <div class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentQuestionTab().id)=='basket'}">
                            <ul class="results editlist big" data-bind="
								visible: basketQuestions().length>0,
                                template: {
                                    name: 'questionResult',
                                    foreach: basketQuestions,
                                }
                            "></ul>
							<div data-bind="visible: basketQuestions().length==0">
								<p class="nothing-here">There's nothing in your basket at the moment. Find questions you'd like to use, and click on the basket icon. They'll show up here so you can easily add them to this exam.</p>
							</div>
                        </div>
                        <div class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentQuestionTab().id)=='search'}">
                            <form class="form-horizontal" data-bind="submit: search.submit">
                                <div class="control-group">
                                    <label for="questionsearch">
                                        <span class="control-label">Search for questions:</span>
                                        <div class="controls">
                                            <div class="input-append">
                                                <input type="text" id="questionsearch" class="search" placeholder="Topic or question name" data-bind="
                                                    value: search.query, 
                                                    valueUpdate: 'afterkeydown'
                                                "/>
                                                <span class="add-on"><button type="submit" class="search" data-bind="css: {loading: search.searching}"></button></span>
                                            </div>
                                        </div>
                                    </label>
                                    <label for="questionsearchtags">
                                        <span class="control-label">Filter by tags:</span>
                                        <div class="controls">
                                            <input type="text" id="questionsearchtags" class="search" placeholder="Tags separated by commas" data-bind="
                                                value: search.tags, 
                                                valueUpdate: 'afterkeydown'
                                            "/>
                                        </div>
                                    </label>
                                </div>
                            </form>
                            <div class="searchBox">
                                <ul class="results editlist big" data-bind="
                                    template: {
                                        name: 'questionResult',
                                        foreach: search.results.all,
                                    }
                                "></ul>
                            </div>
                        </div>
                    </div>
                </div>
			</div>
		</section>
        <section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='versions'}">
            <h4>Editing history</h4>
            <p><label><input type="checkbox" data-bind="checked: showCondensedTimeline"/> Show condensed editing history</label></p>
            <div class="timeline-write-comment">
                <button data-bind="visible: !writingComment(), click: writingComment" type="button">Write a comment</button>
                <form data-bind="fadeVisible: writingComment, submit: submitComment">
                    <h4>Comment</h4>
                    <div data-bind="writemaths: commentText"></div>
                    <div class="buttons">
                        <button type="Submit" data-bind="attr: {disabled: commentIsEmpty}">Submit</button>
                        <button type="button" data-bind="click: cancelComment">Cancel</button>
                    </div>
                </form>
            </div>
            <table class="timeline">
                <tbody data-bind="foreach: timelineToDisplay">
                    <tr class="timeline-event" data-bind="addClass: type, css: {deleting: deleting}">
                        <td>
                            <a data-bind="attr: {href: user.profile_url}" target="_blank"><span data-bind="text: user.name"></span></a>
                        </td>
                        <td>
                            <span data-bind="fromNow: date, attr: {title: date}"></span>
                            <button type="button" class="delete" title="Delete this item" data-bind="visible: delete_url, click: $root.deleteTimelineItem"></button>
                        </td>
                        <!-- ko template: {name: 'timeline-'+type+'-template', data: data} --><!-- /ko -->
                    </tr>
                    <script type="text/html" id="timeline-version-template">
                        <td class="action">
                            Made some changes 
                            <br/>
                            (<a data-bind="attr: {href: 'revert/'+version_pk}" title="Restore this version">Restore</a>)
                        </td>
                        <td>
                            <div class="comment">
                                <div class="edit-comment" data-bind="visible: editable, editableHTML: comment, placeholder: 'Write a comment'"></div>
                                <span data-bind="visible: !editable, text: comment"></span>
                            </div>
                        </td>
                    </script>
                    <script type="text/html" id="timeline-stamp-template">
                        <td class="action">Gave some feedback</td>
                        <td>
                            <span class="stamp-status" data-bind="text: status_display, addClass: status"></span>.
                        </td>
                    </script>
                    <script type="text/html" id="timeline-comment-template">
                        <td class="action">Commented</td>
                        <td>
                            <div data-bind="mathjaxHTML: text"></div>
                        </td>
                    </script>
                </tbody>
            </table>
        </section>
		<section class="tab-pane" data-bind="css: {active: ko.utils.unwrapObservable($root.currentTab().id)=='access'}">
        <div data-bind="template: {name: 'helplink', data: {url: 'http://numbas-editor.readthedocs.org/en/latest/exam-reference.html#access', topic: 'access rights', big: true}}"></div>
            <h4>Public access</h4>
			<form class="form-horizontal">
				<div class="control-group">
					<label>
						<span class="control-label">Public visibility:</span>
						<div class="controls">
							<select data-bind="value: public_access, options: access_options, optionsText:'text',optionsValue:'value'"></select>
						</div>
					</label>
				</div>
			</form>
			<h4>Individual access rights</h4>
			<form class="form-horizontal" data-bind="submit: function(){}">
				<!-- ko foreach: {data: access_rights, afterAdd: Editor.afterAdd} -->
				<div class=control-group">
					<label>
						<span class="control-label" data-bind="text:name"></span>
						<div class="controls">
							<select data-bind="hasfocus: true, value: access_level, options: access_options, optionsText:'text',optionsValue:'value'"></select>
							<button type="button" class="delete" data-bind="click: remove" title="Remove this user's access"></button>
						</div>
					</label>
				</div>
				<!-- /ko -->
				<div class="control-group access-search">
					<label>
						<span class="control-label">Search for a user to give access to:</span>
						<div class="controls">
							<input id="search_author" type="text" size="30" data-bind="
								value: userAccessSearch,
								autocomplete: '{% url 'user_search' %}', 
								autocompleteCallback: function(user) { return {label: user.name, value: user.name} },
								autocompleteSelect: addUserAccess
								"/>
						</div>
					</label>
				</div>
			</form>

            <h4>Access Links</h4>
            <p>Share these links to give automatic access to this exam. Be careful about who you share these with - whoever clicks on the link will be given access.</p>
            <ul class="share-links">
                <li>View: <span class="share-link">{{SITE_ROOT}}{% url 'share_exam' 'view' object.share_uuid %}</span></li>
                <li>Edit: <span class="share-link">{{SITE_ROOT}}{% url 'share_exam' 'edit' object.share_uuid %}</span></li>
            </ul>
		</section>
	</div>

	{% verbatim %}

	<script type="text/html" id="event">
		<h4><span data-bind="html:niceName"></span> <span data-bind="template: {name: 'helplink', data: {url: helpURL}}"></span></h4>
		<div class="control-group">
			<label>
				<span class="control-label">Action:</span>
				<div class="controls">
					<select data-bind="options: actions, value: action, optionsText: 'niceName'"></select>
				</div>
			</label>
		</div>
		<div class="control-group">
			<label data-bind="fadeVisible:action().name!='none'">
				<span class="control-label">Message:</span>
				<div class="controls" data-bind="writemaths: message, wmHeight: 100, wmWidth: 500"/>
			</label>
		</div>
	</script>

	<script type="text/html" id="question">
		<li class="question clearAfter">
			<span class="handle"></span>
			<div class="controls">
				<a class="preview" data-bind="attr: {href: previewURL()}" target="_blank" title="Test run this question"></a>
				<button type="button" class="copy" data-bind="click:replaceWithCopy" title="Replace this question with a copy"></button>
				<button type="button" class="delete delete-grey" data-bind="click:remove" title="Delete this question"></button>
			</div>
			<div class="title">
				<span class="number" data-bind="text: ($index()+1)+'.'"/>
				<a data-bind="attr:{href: url}, text: name, mathjax: name" target="_blank"></a>
			</div>
			<div class="description" data-bind="visible: description.length>0, html: description, mathjax: true"></div>
		</li>
	</script>

	<script type="text/html" id="questionResult">
		<li class="question questionResult">
			<span class="handle" data-bind="click: add"></span>
			<div class="controls">
				<a class="preview" data-bind="attr: {href: previewURL()}" target="_blank" title="Test run this question"></a>
			</div>
			<div class="details">
				<div class="title">
					<a data-bind="attr:{href: url}, text: name, mathjax: name" target="_blank"></a>
				</div>
				<div class="author">
					(<span data-bind="text: author"></span>) - <span data-bind="text: moment(last_modified()).fromNow()"></span>
				</div>
			</div>
			<div class="description" data-bind="visible: description.length>0, html: description, mathjax: true"></div>
		</li>
	</script>
	{% endverbatim %}

{% endblock old_editor %}
