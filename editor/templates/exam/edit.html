{% extends "editor.html" %}
{% load verbatim %}

{% block stylesheets %}
	{{ block.super }}
	<link href="{{ STATIC_URL }}css/exam/edit.css" type="text/css" rel="stylesheet" />
{% endblock stylesheets %}

{% block javascripts %}
    {{ block.super }}

    <!-- exam editor -->
    <script src="{{ STATIC_URL }}js/exam/edit.js" type="text/javascript"></script>

    <script type="text/javascript">
        {% autoescape off %}
        var examJSON = {{ exam_JSON }};
        {% endautoescape %}
        (function() {
            if (!window.Editor) {
            	window.Editor = {};
            }
            window.Editor['preview_url'] = '{% url exam_preview object.pk object.slug %}';
            window.Editor['download_url'] = '{% url exam_download object.pk object.slug %}';
            {% autoescape off %}
            window.Editor['themes'] = {{themes}};
            {% endautoescape %}
        })();
    </script>
{% endblock javascripts %}

{% block content %}
    {{ block.super }}


	{% if user == object.author or user.is_superuser %}
		{% include "editable.html" %}

	    {% verbatim %}
	
			<script type="text/html" id="examTemplate">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					data: {label:'Exam name:',property:name}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					data: {label: 'Theme:', property: theme}
				}"></div>

				<div data-bind="template: {
					name: 'property',
					data: {label:'Duration (minutes):',property:duration, type:'number',min:0}
				}"></div>
				<div data-bind="template: {
					name: 'percentproperty',
					data: {label:'Pass threshold (percent):',property:percentPass}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					data: {label: 'Shuffle questions?',property:shuffleQuestions}
				}"></div>
			</div>

			<div data-bind="folder: 'Navigation'">
				<div>
					<div class="properties">
						<div data-bind="template: {
							name: 'booleanproperty',
							data: {label:'Allow user to regenerate questions?', property:allowregen}
						}"></div>
						<div data-bind="template: {
							name: 'booleanproperty',
							data: {label:'Allow move to previous question?', property:reverse}
						}"></div>
						<div data-bind="template: {
							name: 'booleanproperty',
							data: {label:'Allow jump to any question?', property:browse}
						}"></div>
						<div data-bind="template: {
							name: 'booleanproperty',
							data: {label: 'Show front page?',property:showfrontpage}
						}"></div>
					</div>
					<div data-bind="template: {
						name: 'event',
						data: onadvance
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: onreverse
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: onmove
					}"></div>
				</div>
			</div>

			<div data-bind="folder: 'Timing'">
				<div>
					<div data-bind="template: {
						name: 'event',
						data: timeout
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: timedwarning
					}"></div>
				</div>
			</div>

			<div data-bind="folder: 'Feedback'">
				<div class="properties">
					<div data-bind="template: {
						name: 'booleanproperty',
						data: { label:'Show actual mark?', property:showactualmark}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						data: { label:'Show total mark?', property:showtotalmark}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						data: { label:'Show answer state?', property:showanswerstate}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						data: { label:'Allow reveal answer?', property:allowrevealanswer}
					}"></div>
					<div data-bind="template: {
						name: 'percentproperty',
						data: { label:'Advice threshold (percent)', property:advicethreshold}
					}"></div>
				</div>
			</div>

			<div data-bind="folder: {label: 'Questions', show: true}">
				<div class="questions">
					<ol class="questionList editlist big" data-bind="
						template:{
							name:'question',
							foreach: questions,
							beforeRemove: function(elem) { $(elem).slideUp(150,function(){$(this).remove()}); },
							afterAdd: function(elem) { $(elem).hide().slideDown(150) }
						},
						sortableList: {list: questions, add: questionAdder()}
					"></ol>
					<div class="searchBox">
						<label for="questionsearch">Search for questions: </label>
						<input type="text" name="questionsearch" class="search" data-bind="
							value: questionSearch, 
							valueUpdate: 'afterkeydown',
							css: {loading: searching()}
						"/>
						<ul class="results editlist big" data-bind="
							template: {
								name: 'questionResult',
								foreach: questionSearchResults
							}
						"></ul>
					</div>
				</div>
			</div>
		</script>
	
		<script type="text/html" id="event">
			<div data-bind="folder: niceName">
				<div>
				<div class="properties">
					<div data-bind="template: {
						name: 'property',
						data: {label: 'Action:', property: action().niceName}
					}">
					</div>
				</div>
				<div data-bind="fadeVisible:action().value!='none'">
					Message: 
					<div data-bind="writemaths: message"/>
				</div>
				</div>
			</div>
		</script>
	
		<script type="text/html" id="question">
			<li class="question">
				<span class="handle"></span>
				<a data-bind="attr:{href: url}, text: name" target="_blank"></a>
				<button class="remove" data-bind="click:remove"></button>
			</li>
		</script>

		<script type="text/html" id="questionResult">
			<li class="questionResult" data-bind="dragOut: {data: $data, sortable: '.questions ul.editlist'}">
				<span class="handle"></span>
				<a data-bind="attr: {href: url}, text: name" target="_blank"></span>
			</li>
		</script>
	    {% endverbatim %}
	
    {% else %}
			{% include "noneditable.html" %}
    
    	    {% verbatim %}
	
			<script type="text/html" id="examTemplate">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					data: {label:'Exam name:',property:name}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					data: {label: 'Theme:', property: theme}
				}">
                </div>

				<div data-bind="template: {
					name: 'property',
					data: {label:'Duration (minutes):',property:duration, type:'number',min:0}
				}"></div>
				<div data-bind="template: {
					name: 'percentproperty',
					data: {label:'Pass threshold (percent):',property:percentPass}
				}"></div>
				<div data-bind="template: {
					name: 'property',
					data: {label: 'Shuffle questions?',property:shuffleQuestions}
				}"></div>
			</div>

			<div data-bind="folder: 'Navigation'">
				<div>
					<div class="properties">
						<div data-bind="template: {
							name: 'property',
							data: {label:'Allow user to regenerate questions?', property:allowregen}
						}"></div>
						<div data-bind="template: {
							name: 'property',
							data: {label:'Allow move to previous question?', property:reverse}
						}"></div>
						<div data-bind="template: {
							name: 'property',
							data: {label:'Allow jump to any question?', property:browse}
						}"></div>
						<div data-bind="template: {
							name: 'property',
							data: {label: 'Show front page?',property:showfrontpage}
						}"></div>
					</div>
					<div data-bind="template: {
						name: 'event',
						data: onadvance
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: onreverse
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: onmove
					}"></div>
				</div>
			</div>

			<div data-bind="folder: 'Timing'">
				<div>
					<div data-bind="template: {
						name: 'event',
						data: timeout
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: timedwarning
					}"></div>
				</div>
			</div>

			<div data-bind="folder: 'Feedback'">
				<div class="properties">
					<div data-bind="template: {
						name: 'property',
						data: { label:'Show actual mark?', property:showactualmark}
					}"></div>
					<div data-bind="template: {
						name: 'property',
						data: { label:'Show total mark?', property:showtotalmark}
					}"></div>
					<div data-bind="template: {
						name: 'property',
						data: { label:'Show answer state?', property:showanswerstate}
					}"></div>
					<div data-bind="template: {
						name: 'property',
						data: { label:'Allow reveal answer?', property:allowrevealanswer}
					}"></div>
					<div data-bind="template: {
						name: 'percentproperty',
						data: { label:'Advice threshold (percent)', property:advicethreshold}
					}"></div>
				</div>
			</div>

			<div data-bind="folder: {label: 'Questions', show:true}">
				<div class="questions">
					<ol data-bind="
						template:{
							name:'question',
							foreach: questions,
						},
					"></ol>
				</div>
			</div>
		</script>
	
		<script type="text/html" id="event">
			<div data-bind="folder: niceName">
				<div>
				<div class="properties">
					<div data-bind="template: {
						name: 'property',
						data: {label: 'Action:', property: action().niceName}
					}">
					</div>
				</div>
				<div data-bind="fadeVisible:action().value!='none'">
					Message: 
					<div class="textblock" data-bind="html: message"/>
				</div>
				</div>
			</div>
		</script>
	
		<script type="text/html" id="question">
			<li class="question">
				<a data-bind="attr:{href: url}, text: name" target="_blank"></a>
			</li>
		</script>

	    {% endverbatim %}
	{% endif %}

	<div>
		<div id="controls">
			<div class="controlbox" id="author">
				Author: {{ object.author.first_name }} {{ object.author.last_name }} ({{ object.author.username }})
			</div>
			<div class="controlbox" id="buttons">
				Download: 
				<a href="{% url exam_download object.pk object.slug %}">standalone .zip</a>,
				<a href="{% url exam_download object.pk object.slug %}?scorm">SCORM package</a>,
				<a href="{% url exam_source object.pk object.slug %}">source</a>
			</div>
			<div class="controlbox" id="admin">
				<button id="preview" data-bind="click: showPreview">Test Run</button>
				<a id="copy" href="{% url exam_copy object.pk object.slug %}">Make a Copy</a>
			</div>
		</div>
		<div id="editor" data-bind="template: 'examTemplate'">Loading...</div>
	</div>
{% endblock content %}

{% block sidebar %}
{% endblock sidebar %}

