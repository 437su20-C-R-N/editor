{% extends "editor.html" %}
{% load verbatim %}

{% block javascripts %}
    {{ block.super }}

    <!-- exam editor -->
    <script src="{{ STATIC_URL }}js/exam-editor.js" type="text/javascript"></script>

    <script type="text/javascript">
        {% autoescape off %}
        var examJSON = {{ exam_JSON }};
        {% endautoescape %}
        (function() {
            if (!window.Editor) {
            	window.Editor = {};
            }
            window.Editor['exam_preview_url'] = '{% url exam_preview object.pk object.slug %}';
        })();
    </script>
{% endblock javascripts %}

{% block content %}
    {{block.super }}

    <div id="fallback-form">
        <h2>{{ object.name }}</h2>

        {% if error %}<p><strong>{{ error }}</strong></p>{% endif %}

        <form action="{% url exam_edit object.pk object.slug %}" method="post" id="edit-form">
            {% csrf_token %}
            {{ form.as_p }}
            {% for formset in inlines %}
                {{ formset.as_p }}
            {% endfor %}
            <input type="submit" value="Submit" />
        </form>
    </div>

    {% verbatim %}

		<script type="text/x-jquery-tmpl" id="examTemplate">
			<div class="properties">
				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Exam name:',property:name}
				}"></div>

				<div>
					<label>Tags:</label>
					<div data-bind="listbox: tags"></div>
				</div>

				<div data-bind="template: {
					name: 'property',
					templateOptions: {label:'Duration (minutes):',property:duration, type:'number',min:0}
				}"></div>
				<div data-bind="template: {
					name: 'percentproperty',
					templateOptions: {label:'Pass threshold (percent):',property:percentPass}
				}"></div>
				<div data-bind="template: {
					name: 'booleanproperty',
					templateOptions: {label: 'Shuffle questions?',property:shuffleQuestions}
				}"></div>
			</div>
			{{wrap(this,{label:"Navigation"}) "#folder"}}
				<div>
					<div class="properties">
						<div data-bind="template: {
							name: 'booleanproperty',
							templateOptions: {label:'Allow user to regenerate questions?', property:allowregen}
						}"></div>
						<div data-bind="template: {
							name: 'booleanproperty',
							templateOptions: {label:'Allow move to previous question?', property:reverse}
						}"></div>
						<div data-bind="template: {
							name: 'booleanproperty',
							templateOptions: {label:'Allow jump to any question?', property:browse}
						}"></div>
						<div data-bind="template: {
							name: 'booleanproperty',
							templateOptions: {label: 'Show front page?',property:showfrontpage}
						}"></div>
					</div>
					<div data-bind="template: {
						name: 'event',
						data: onadvance
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: onreverse
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: onmove
					}"></div>
				</div>
			{{/wrap}}
			{{wrap(this,{label:"Timing"}) "#folder"}}
				<div>
					<div data-bind="template: {
						name: 'event',
						data: timeout
					}"></div>
					<div data-bind="template: {
						name: 'event',
						data: timedwarning
					}"></div>
				</div>
			{{/wrap}}
			{{wrap(this,{label:"Feedback"}) "#folder"}}
				<div class="properties">
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: { label:'Show actual mark?', property:showactualmark}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: { label:'Show total mark?', property:showtotalmark}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: { label:'Show answer state?', property:showanswerstate}
					}"></div>
					<div data-bind="template: {
						name: 'booleanproperty',
						templateOptions: { label:'Allow reveal answer?', property:allowreavealanswer}
					}"></div>
					<div data-bind="template: {
						name: 'percentproperty',
						templateOptions: { label:'Advice threshold (percent)', property:advicethreshold}
					}"></div>
				</div>
			{{/wrap}}
			{{wrap(this,{label:"Rulesets"}) "#folder"}}
			<div class="rulesets">
				<ul class="editlist" data-bind="template:{
					name:'ruleset',
					foreach: rulesets,
					beforeRemove: function(elem) { $(elem).slideUp(150) },
					afterAdd: function(elem) { $(elem).hide().slideDown(150) }
				}"></ul>
				<button data-bind="click:addRuleset, text: rulesets().length ? 'Add another ruleset' : 'Add a ruleset'"></button>
			</div>
			{{/wrap}}
			{{wrap(this,{label:"Questions"}) "#folder"}}
			<div class="questions">
				<ul class="editlist" data-bind="
					template:{
						name:'question',
						foreach: questions,
						beforeRemove: function(elem) { $(elem).slideUp(150) },
						afterAdd: function(elem) { $(elem).hide().slideDown(150) }
					},
					sortableList: questions
				"></ul>
				<button data-bind="click: addQuestion, text: questions().length ? 'Add another question' : 'Add a question'"></button>
			</div>
			{{/wrap}}
		</script>

		<script type="text/x-jquery-tmpl" id="event">
			{{wrap(this,{label:niceName}) "#folder"}}
				<div>
				<div class="properties">
					<div>
						<label>Action: </label>
						<select data-bind="options: actions, value: action, optionsText: 'niceName'"></select>
					</div>
				</div>
				<div data-bind="fadeVisible:action().value!='none'">
					Message: 
					<div data-bind="writemaths: message"/>
				</div>
				</div>
			{{/wrap}}
		</script>

		<script type="text/x-jquery-tmpl" id="ruleset">
			<li class="ruleset">
				<input type="text" data-bind="value:name, valueUpdate: 'input'"/>: <div data-bind="listbox:sets, rulesetcomplete: allsets"></div>
				<button class="remove" data-bind="click:remove"></button>
			</li>
		</script>

		<script type="text/x-jquery-tmpl" id="question">
			<li class="question">
				<span class="handle"></span>
				<div data-bind="searchClick: {value: name, options: exam.allQuestions}"></div>
				<button class="remove" data-bind="click:remove"></button>
			</li>
		</script>

		<div>
		    <button id="preview" type="button" data-bind="click: showPreview">Test Run</button>
			<div id="editor" data-bind="template: 'examTemplate'"></div>
		</div>
    {% endverbatim %}
{% endblock content %}

{% block sidebar %}
{% endblock sidebar %}

