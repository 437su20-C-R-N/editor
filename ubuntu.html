<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Numbas editor - Ubuntu installation</title>
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/2.1.3/normalize.min.css"></link>
	<link rel="stylesheet" href="style.css"></link>
	</head>
	<body>
		<a class="index-link" href="index.html">Numbas installation instructions</a>
		<h1>Ubuntu installation</h1>
		<p>
			These are outline instructions on setting up the Numbas editor with a backend MySQL
			database. The following is for an Ubuntu Precise (12.04) Linux server.
		</p>

		<h2>Essential package installation</h2>
		<p>
			Packages that would be installed as part of a standard Ubuntu install are
			not listed.	Python 3 is required for compilation of Numbas exams; Python
			2.6 (or greater) is required for Django.
		</p>
		<ul>
			<li>
				Install Apache, Git, Apache WSGI module, MySQL, Python 3, and the
				Python Imaging Library using the packaging system: 
				<code class="shell">apt-get
					install apache2 git-core libapache2-mod-wsgi mysql-server
					mysql-common python3 python-imaging acl</code>
			</li>
			<li>Enable mod_wsgi:
				<code class="shell">a2enmod wsgi</code>
			</li>
		</ul>

		<h2>Virtualenv</h2>
		<p>
			Rather than rely on the packaged version of Django, a more flexible approach is to use <a href="http://www.virtualenv.org/">virtualenv</a>, which is a tool to create an isolated Python environment.
		</p>
		<ul>
			<li>
				Create a user group which will have access to the virtualenv, and add yourself to it. 
				<code class="shell">groupadd numbas</code>
				<code class="shell">usermod username -a -G numbas,www-data</code>
				You might need to log out and back in for the group change to take effect.
			</li>
			<li>
				Install Pip: <code class="shell">apt-get install python-pip</code>
			</li>
			<li>
				Install virtualenv: <code class="shell">pip install virtualenv</code>
			</li>
			<li>
				Create the virtualenv in a suitable location: 
				<code class="shell">mkdir /opt/python</code>
				<code class="shell">setfacl -dR -m g:numbas:rwx /opt/python</code>
				<code class="shell">virtualenv /opt/python/numbas-editor</code>
			</li>
			<li>
				Activate the virtualenv: <code class="shell">source /opt/python/numbas-editor/bin/activate</code> (This ensures that subsequent python packages are installed in this isolated environment, and not in the system environment.)
			</li>
			<li>Install extra packages to ensure Python packages compile and install correctly: <code class="shell">apt-get install libmysqlclient-dev python-dev python-tk tcl-dev tk-dev</code>
			</li>
		</ul>

		<h2>Configuration</h2>
		<ul>
			<li>Create database <code>numbas_editor</code></li>
			<li>Create database user and grant privileges on
			<code>numbas_editor</code> database:
				<ul>
					<li><code class="shell mysql">grant all privileges on numbas_editor.* to
						'numbas'@'localhost' identified by 'password';</code>
					</li>
				</ul>
			</li>
			<li>Create Numbas directories outside the webroot:
			 <code class="shell">mkdir /srv/numbas</code>
			 <code class="shell">mkdir /srv/numbas/dist</code>
			 <code class="shell">mkdir /srv/numbas/media</code>
			 <code class="shell">mkdir /srv/numbas/previews</code>
			 <code class="shell">mkdir /srv/numbas/static</code>
			</li>
			<li>Set the correct ownership and permissions (need file system ACLs
			enabled on <code>/srv</code>):
				<code class="shell">chmod 2770 media previews</code>
				<code class="shell">chmod 2750 dist static</code>
				<code class="shell">chgrp www-data dist media previews static</code>
				<code class="shell">setfacl -dR -m g::rwX media previews</code>
				<code class="shell">setfacl -dR -m g::rX dist static</code>
			</li>
			<li>Clone the Numbas repository: <code class="shell">git clone git://github.com/numbas/Numbas /srv/numbas/dist</code></li>
			<li>Create the editor directory and clone the editor under webroot: <code class="shell">git clone git://github.com/numbas/editor /srv/www/numbas_editor</code></li>
			<li>Install the Python module dependencies of the editor (in the virtualenv): 
				<code class="shell">pip install -r /srv/www/numbas_editor/numbas/requirements.pip</code>
				<code class="shell">pip install MySQL-python</code>
			</li>
			<li>Copy the editor distribution database and settings files:
					<code class="shell">cd /srv/www/numbas_editor/numbas</code>
					<code class="shell">cp database.py.dist database.py</code>
					<code class="shell">cp settings.py.dist settings.py</code>
			</li>
			<li>Edit <code>database.py</code>:
				<ul>
					<li>Set <code>ENGINE</code> to
					<code>django.db.backends.mysql</code></li>
					<li>Set <code>NAME</code> to the database name
					(<code>numbas_editor</code>)</li>
					<li>Set <code>USER</code> to the database user
					(<code>numbas</code>)</li>
					<li>Set <code>PASSWORD</code> to the database password
					(<code>password</code>)</li>
				</ul>
			</li>
			<li>Edit <code>settings.py</code>:
				<ul>
					<li>Make sure settings in <code>GLOBAL_SETTINGS</code>,
						<code>MEDIA_ROOT</code>, and <code>STATIC_ROOT</code> match those
						above.</li>
					<li><code>PREVIEW_URL</code> should be set to the URL at which
					preview exams can be viewed (see Apache 2 config file).</li>
					<li><code>PYTHON_EXEC</code> is the path to the Python 3
					executable.</li>
				</ul>
			</li>
			<li>Sync the database:
				<ul>
					<li><code class="shell">cd /srv/www/numbas_editor</code></li>
					<li><code class="shell">python manage.py syncdb</code></li>
					<li>Create a superuser (answer <code>yes</code>)</li>
					<li>Enter username, e-mail address, and password</li>
				</ul>
			</li>
			<li>Set up static files: <code class="shell">python manage.py collectstatic --noinput</code></li>
			<li>Copy <code>editor/templates/index.html.dist</code> to
			<code>editor/templates/index.html</code> and customise.</li>
			<li>Copy <code>web/django.wsgi.dist</code> to
			<code>web/django.wsgi</code> and edit:
				<ul>
					<li>Make sure the <code>sys.path.append</code> line matches the
					path to the editor on the file system.</li>
					<li><code>DJANGO_SETTINGS_MODULE</code> should be set to
					<code>numbas.settings</code> (if following the above naming
					scheme).</li>
				</ul>
			</li>
			<li>Create apache config file and enable the site.
				<ul>
					<li>Edit <code>/etc/apache2/sites-available/numbas_editor</code> with
					contents similar to that in <a
						href="apache2_ubuntu.conf"><code>apache2_ubuntu.conf</code></a>.
					If following these instructions exactly, then all that needs changing
					are the lines <code>ServerName</code> and <code>ServerAdmin</code>.
					<li><code class="shell">a2ensite numbas_editor &amp;&amp; service apache2 reload</code></li>
				</ul>
			</li>
			<li>Point a web browser at the server hosting the editor.</li>
		</ul>
		
		<h2>Self registration</h2>
		<p>
			To allow users to register themselves within the editor, edit
			<code>settings.py</code> and set <code>ALLOW_REGISTRATION = True</code>.
			An e-mail is sent to the user, providing a link that they must click on
			to complete the registration process.	To complete the self registration
			configuration do the following:
		</p>
		<ul>
			<li>
				Set <code>DEFAULT_FROM_EMAIL</code> to something sensible.	This is
				where the self-registration e-mails will appear to come from.
			</li>
			<li>
				Log in to the admin interface of the editor (by going to
				<code>http://server.domain/admin/</code>) as the admin user you created
				earlier.	Click on <code>Sites</code>, then <code>example.com</code>,
				then change both fields to <code>server.domain</code>.	This sets the
				URL that will appear in the self-registration e-mails.
			</li>
		</ul>
		<h2>LDAP authentication</h2>
		<p>
			LDAP authentication is possible within the editor.	This can work in
			combination with the default Django Model authentication backend.
		</p>
		
		<h3>Extra required packages</h3>
		<ul>
			<li>Python LDAP: <code class="shell">apt-get install python-ldap libldap2-dev libsasl2-dev</code></li>
			<li>Django LDAP: <code class="shell">pip install django-auth-ldap</code></li>
			<li>GnuTLS (for secure LDAP lookups only): <code class="shell">apt-get install libgnutls26</code></li>
		</ul>
		
		<h3>Extra configuration</h3>
		<ul>
			<li>Copy <code>ldap_auth.py.dist</code> to <code>ldap_auth.py</code>
				and edit, following the comments in that file.</li>
		<li>In <code>settings.py</code> uncomment the LDAP auth line in
			<code>AUTHENTICATION_BACKENDS</code> and the <code>ldap_auth</code>
			import line.</li>
		</ul>

		<h2>Shibboleth authentication</h2>
		<p>
			The editor also supports Shibboleth authentication, using the Django
			Remote User backend and the <a
				href="https://github.com/Brown-University-Library/django-shibboleth-remoteuser">django-shibboleth-remoteuser</a>
			middleware.
		</p>

		<h3>Extra configuration</h3>
		<p>
			Apache setup for a Shibboleth service provider (SP) is beyond the scope
			of this installation guide, and depends on the setup of the local
			Identity Provider (IdP).
		</p>

		<p>
			Once the SP is set up, do the following.
		</p>
		<ul>
			<li>Copy <code>shib_auth.py.dist</code> to <code>shib_auth.py</code>
				and edit, following the comments in that file.</li>
			<li>In <code>settings.py</code> uncomment the relevant line in
				<code>MIDDLEWARE_CLASSES</code>, the <code>RemoteUser</code> backend in
				<code>AUTHENTICATION_BACKENDS</code>, and the <code>shib_auth</code>
				import line.</li>
		</ul>
		
		<p>
			<b>Note that if any changes are made to the editor code, including
				editing the settings files, then for the web server to recognise these
				changes either touch the <code>web/django.wsgi</code> file, or restart
				the Apache server.</b>
		</p>
	</body>
</html>
