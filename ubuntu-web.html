<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Numbas editor - Ubuntu installation</title>
        <link rel="stylesheet" href="normalize.css"></link>
        <link rel="stylesheet" href="style.css"></link>
	</head>
	<body>
        <a class="index-link" href="index.html">&larr; Numbas editor installation instructions</a>

		<h1>Installing the Numbas editor on Ubuntu</h1>
		<p>
			These are outline instructions on setting up the Numbas editor with a backend MySQL
            database. 
        </p>

        <p>
            <strong>
            The following instructions are for a server running Ubuntu Xenial (16.04) or newer.
            </strong>
        </p>

        <section>
		<h2>Essential package installation</h2>
		<p>
			Packages that would be installed as part of a standard Ubuntu install are
			not listed.
		</p>
		<ul>
			<li>
				Install Apache, Git, Apache WSGI module, MySQL and Python 3 using the packaging system: 
				<code class="shell">apt-get
					install apache2 apache2-dev git-core mysql-server
                    mysql-common python3 acl libmysqlclient-dev python-dev 
                    libapache2-mod-wsgi-py3 python-tk tcl-dev tk-dev</code>
			</li>
			<li>Enable mod_wsgi, if it's not already:
				<code class="shell">a2enmod wsgi</code>
			</li>
		</ul>
        </section>

        <section>
		<h2>Virtualenv</h2>
		<p>
			Rather than rely on the packaged version of Django, a more flexible approach is to use <a href="http://www.virtualenv.org/">virtualenv</a>, which is a tool to create an isolated Python environment.
		</p>
		<ul>
			<li>
				Create a user group which will have access to the virtualenv, and add yourself to it. 
				<code class="shell">groupadd numbas</code>
                <code class="shell">usermod <span class="shell-variable">your username</span> -a -G numbas,www-data</code>
				You might need to log out and back in for the group change to take effect.
			</li>
			<li>
                Install Pip: 
                <code class="shell">apt-get install python3-pip</code>
			</li>
			<li>
                Install virtualenv: 
                <code class="shell">pip3 install virtualenv</code>
			</li>
			<li>
				Create the virtualenv in a suitable location: 
				<code class="shell">mkdir /opt/python</code>
				<code class="shell">setfacl -dR -m g:numbas:rwx /opt/python</code>
				<code class="shell">virtualenv /opt/python/numbas-editor</code>
			</li>
			<li>
				Activate the virtualenv: <code class="shell">source /opt/python/numbas-editor/bin/activate</code> (This ensures that subsequent python packages are installed in this isolated environment, and not in the system environment.)
			</li>
        </ul>
        </section>

		<section>
		<h2>Database</h2>
		<ul>
			<li>
				Create a MySQL database called <code>numbas_editor</code>:
				<ul>
					<li>
						<code class="shell mysql">create database numbas_editor;</code>
					</li>
				</ul>
			</li>
			<li>Create a database user and grant privileges on
			<code>numbas_editor</code> database, with a password of your choice:
				<ul>
					<li><code class="shell mysql">grant all privileges on numbas_editor.* to
                        'numbas'@'localhost' identified by '<span class="shell-variable">password</span>';</code>
					</li>
				</ul>
			</li>
		</ul>
		</section>

		<section>
		<h2>Create directories and set permissions</h2>
		<ul>
			<li>Create the following directories outside the web root, so they're not accessible to the public:
			 <code class="shell">mkdir /srv/numbas</code>
			 <code class="shell">mkdir /srv/numbas/compiler</code>
			 <code class="shell">mkdir /srv/numbas/media</code>
			 <code class="shell">mkdir /srv/numbas/previews</code>
			 <code class="shell">mkdir /srv/numbas/static</code>
			</li>
			<li>Set the correct ownership and permissions:
                <code class="shell">cd /srv/numbas</code>
				<code class="shell">chmod 2770 media previews</code>
				<code class="shell">chmod 2750 compiler static</code>
				<code class="shell">chgrp www-data compiler media previews static</code>
				<code class="shell">setfacl -dR -m g::rwX media previews</code>
				<code class="shell">setfacl -dR -m g::rX compiler static</code>
			</li>
		</ul>
		</section>

		<section>
		<h2>Clone the editor and compiler repositories</h2>
		<ul>
			<li>Clone the Numbas repository: <code class="shell">git clone git://github.com/numbas/Numbas /srv/numbas/compiler</code></li>
			<li>Clone the editor under the webroot directory: <code class="shell">git clone git://github.com/numbas/editor /srv/www/numbas_editor</code></li>
			<li>Install the Python module dependencies of the editor (in the virtualenv): 
				<code class="shell">pip install -r /srv/www/numbas_editor/requirements.txt</code>
				<code class="shell">pip install -r /srv/numbas/compiler/requirements.txt</code>
				<code class="shell">pip install mysqlclient mod_wsgi</code>
			</li>
		</ul>
		</section>

        <section>
		<h2>Configuration</h2>
        <ul>
            <li>
                <p>Run <code class="shell">python first_setup.py</code></p>
                <p>This will configure the editor based on your answers to a few questions, and write <code>numbas/settings.py</code>.</p>
                <p>If you've been following these instructions exactly, you can accept the defaults for most of the questions.</p>
                <p>If you make any mistakes, you can run the script again, or edit <code>numbas/settings.py</code> directly.</p>
            </li>
			<li>Create apache config file and enable the site.
				<ul>
					<li>Edit <code>/etc/apache2/sites-available/numbas_editor.conf</code> with
					contents similar to that in <a
						href="apache2_ubuntu.conf"><code>apache2_ubuntu.conf</code></a>.
					If following these instructions exactly, then all that needs changing
					are the lines <code>ServerName</code> and <code>ServerAdmin</code>.
                    <li>
                        <code class="shell">a2ensite numbas_editor.conf</code>
                        <code class="shell">service apache2 reload</code>
                    </li>
				</ul>
			</li>
			<li>Point a web browser at the server hosting the editor.</li>
        </ul>
        </section>

        <section>
        <h2>Ongoing maintenance</h2>

        <p>
            To keep the editor up to date, run the following script:
            <code class="shell">source /opt/python/numbas-editor/bin/activate</code>
            <code class="shell">cd /srv/numbas/compiler</code>
            <code class="shell">git pull origin master</code>
            <code class="shell">pip install -r requirements.txt</code>
            <code class="shell">cd /srv/www/numbas_editor</code>
            <code class="shell">git pull origin master</code>
            <code class="shell">python manage.py migrate</code>
            <code class="shell">python manage.py collectstatic --noinput</code>
            <code class="shell">pip install -r requirements.txt</code>
            <code class="shell">touch web/django.wsgi</code>
        </p>
		<p>
            <em>
                Note that if any changes are made to the editor code, including
				editing the settings files, then for the web server to recognise these
                changes you must either <code>touch</code> the <code>web/django.wsgi</code> file, or restart
                the Apache server.
            </em>
		</p>

        <footer>
            <p><a href="http://www.numbas.org.uk">Numbas</a> is an open-source, web-based e-assessment system.</p>
        </footer>
	</body>
</html>
