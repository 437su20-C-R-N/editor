<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Numbas editor</title>
  </head>
  <body>
    <h1>SUSE installation</h1>
    <p>
      Outline instructions on setting up the Numbas editor with a backend MySQL
      database.  The following is for a SUSE Asparagus (12.1) Linux server.
    </p>

    <h2>Package installation</h2>
    <p>
      Packages that would be installed as part of a standard minimal server
      install are not listed.  Python 3 is required for compilation of Numbas
      exams; Python 2.6 (or greater) is required for Django.
    </p>
    <ul>
      <li>Install Apache, Git, Apache WSGI module, MySQL, Python 3, Python
        MySQLdb interface: <code>yast -i apache2 apache2-mod_wsgi git
        mysql-cluster python-mysql python3 python3-xml</code></li>
      <li>Install Django (need at least version 1.3): <code>yast -i python-django</code></li>
      <li>Install some extra packages for Python module compilation: <code>yast
        -i gcc python-devel zlib-devel</code>
      <li>Install Pip: <code>yast -i python-pip</code></li>
      <li>Install GitPython: <code>pip install GitPython</code></li>
      <li>Install Django Taggit: <code>pip install django-taggit</code></li>
      <li>Install Django registration: <code>pip install
          django-registration</code></li>
      <li>Bug in GitPython.  Change <code>util.py</code> by adding <code>import
        pwd</code> to the top, and edit <code>def get_user_id()</code>
      replacing <code>username = os.getlogin()</code> with <code>username =
        pwd.getpwuid(os.getuid()).pw_name</code></li>
    </ul>

    <h2>Configuration</h2>
    <ul>
      <li>Make sure the relevant HTTP service is allowed through the
      firewall.</li>
      <li>Make sure the web server and MySQL server start at system startup:
      <code>insserv apache2</code>, <code>insserv mysql</code>.
    </ul>
    <ul>
      <li>Create database <code>numbas_editor</code></li>
      <li>Create database user and grant privileges on
      <code>numbas_editor</code> database:
        <ul>
          <li><code>grant all privileges on numbas_editor.* to
            'numbas'@'localhost' identified by 'password';</code></li>
        </ul>
      </li>
      <li>Create Numbas directories outside the webroot:
        <ul>
          <li><code>mkdir /srv/numbas</code></li>
          <li><code>mkdir /srv/numbas/dist</code></li>
          <li><code>mkdir /srv/numbas/previews</code></li>
          <li><code>mkdir /srv/numbas/questiondb</code></li>
          <li><code>mkdir /srv/numbas/static</code></li>
        </ul>
      </li>
      <li>Set the correct ownership and permissions (need file system ACLs
      enabled on <code>/srv</code>):
        <ul>
          <li><code>chmod 2770 previews questiondb</code></li>
          <li><code>chmod 2750 dist static</code></li>
          <li><code>chgrp www dist previews questiondb static</code></li>
          <li><code>setfacl -R -m g:www:rwX previews questiondb</code></li>
          <li><code>setfacl -dR -m g:www:rwX previews questiondb</code></li>
          <li><code>setfacl -R -m g:www:rX dist static</code></li>
          <li><code>setfacl -dR -m g:www:rX dist static</code></li>
        </ul>
      </li>
      <li>Clone the Numbas repository: <code>git clone
        git://github.com/numbas/Numbas /srv/numbas/dist</code></li>
      <li>Create the question/exam database:
        <ul>
          <li><code>cd /srv/numbas/questiondb</code></li>
          <li><code>mkdir exams questions</code></li>
          <li><code>git init</code></li>
        </ul>
      </li>
      <li>Create the editor directory and clone the editor under webroot:
        <ul>
          <li><code>git clone git://github.com/numbas/editor
            /srv/www/numbas_editor</code></li>
        </ul>
      </li>
      <li>Copy the editor distribution database and settings files:
        <ul>
          <li><code>cd /srv/www/numbas_editor</code></li>
          <li><code>cp database.py.dist database.py</code></li>
          <li><code>cp settings.py.dist settings.py</code></li>
        </ul>
      </li>
      <li>Edit <code>database.py</code>:
        <ul>
          <li>Set <code>ENGINE</code> to
          <code>django.db.backends.mysql</code></li>
          <li>Set <code>NAME</code> to the database name
          (<code>numbas_editor</code>)</li>
          <li>Set <code>USER</code> to the database user
          (<code>numbas</code>)</li>
          <li>Set <code>PASSWORD</code> to the database password
          (<code>password</code>)</li>
        </ul>
      </li>
      <li>Edit <code>settings.py</code>:
        <ul>
          <li>Make sure settings in <code>GLOBAL_SETTINGS</code> match those
          above</li>
          <li><code>PREVIEW_URL</code> should be set to the URL at which
          preview exams can be viewed (see Apache 2 config file).</li>
          <li><code>HELP_URL</code> should be set to the URL at which the
            Numbas web documentation can be viewed (see Apache 2 config
            file).</li>
          <li><code>PYTHON_EXEC</code> is the path to the Python 3
          executable.</li>
        </ul>
      </li>
      <li>Sync the database:
        <ul>
          <li><code>python manage.py syncdb</code></li>
          <li>Create a superuser (answer <code>yes</code>)</li>
          <li>Enter username, e-mail address, and password</li>
        </ul>
      </li>
      <li>Set up static files: <code>python manage.py collectstatic --noinput</code></li>
      <li>Copy <code>editor/templates/index.html.dist</code> to
      <code>editor/templates/index.html</code> and customise.</li>
      <li>Copy <code>web/django.wsgi.dist</code> to
      <code>web/django.wsgi</code> and edit:
        <ul>
          <li>Make sure the two <code>sys.path.append</code> lines match the
          paths on the file system.</li>
          <li><code>DJANGO_SETTINGS_MODULE</code> should be set to
          <code>numbas_editor.settings</code> (if following above naming
          scheme).</li>
        </ul>
      </li>
      <li>Create apache config file and enable the site.
        <ul>
          <li>Edit <code>/etc/apache2/vhosts.d/numbas_editor.conf</code> with
          contents similar to that in <a
            href="apache2_suse.conf"><code>apache2_suse.conf</code></a>.
          If following these instructions exactly, then all that needs changing
          are the lines <code>ServerName</code>, <code>ServerAdmin</code>, and
          <code>WSGIDaemonProcess</code>.</li>
          <li>Ordinarily <code>WSGIProcessGroup</code> should also be set to
          <code>server.domain</code>, but there is a bug (issue #13156) in
          Python 2.7.2 (the default Python version in SUSE 12.1) such that it
          must be set to <code>%{GLOBAL}</code>.  This problem does not exist
          in any other version of Python 2.</li>
        </ul>
      </li>
      <li>Enable the Apache WSGI module: <code>a2enmod wsgi</code>.
      <li>Restart the web server, then point a web browser at the server
      hosting the editor.</li>
    </ul>
    
    <h2>LDAP authentication</h2>
    <p>
    	LDAP authentication is possible within the editor.  This can work in
    	combination with the default Django Model authentication backend.
    </p>
    
    <h3>Extra required packages</h3>
	<ul>
		<li>Python LDAP: <code>yast -i python-ldap</code></li>
		<li>Django LDAP: <code>pip install django-auth-ldap</code></li>
    <li>GnuTLS (for secure LDAP lookups only): probably already installed, but
    if not <code>yast -i libgnutls28</code></li>
	</ul>
	
	<h3>Extra configuration</h3>
    <ul>
    	<li>Copy <code>ldap_auth.py.dist</code> to <code>ldap_auth.py</code>
      and edit, following the comments in that file.</li>
		  <li>In <code>settings.py</code> uncomment the LDAP auth line in
			<code>AUTHENTICATION_BACKENDS</code> and the <code>ldap_auth</code>
			import line.</li>
    </ul>
    
    <p>
      <b>Note that if any changes are made to the editor code, including
        editing the settings files, then for the web server to recognise these
        changes either touch the <code>web/django.wsgi</code> file, or restart
        the Apache server.</b>
    </p>
  </body>
</html>
