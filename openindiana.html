<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Numbas editor</title>
  </head>
  <body>
    <h1>OpenIndiana/Solaris installation</h1>
    <p>
      Outline instructions on setting up the Numbas editor with a backend MySQL
      database.  The following is for an OpenIndiana 151a Unix server.  The same
      instructions should also work for Solaris 11, possibly with minor
      modifications.
    </p>

    <h2>Package installation</h2>
    <p>
      Packages that would be installed as part of a standard OpenIndiana
      install are not listed.  Python 3 is required for compilation of Numbas
      exams; Python 2.6 (or greater) is required for Django.
    </p>

    <h3>Apache/WSGI</h3>
    <h4>Apache</h4>
    <ul>
      <li>
        Install Apache web server: <code>pkg install apache-22</code>
      </li>
      <li>
        Enable web server on startup: <code>svcadm enable apache22</code> (logs
        in <code>/var/apache2/2.2/logs</code>).
      </li>
    </ul>

    <h4>WSGI</h4>
    <ul>
      <li>
        Install <code>ucb</code> compatibility package: <code>pkg install
          ucb</code> (otherwise mod_wsgi build fails with <code>/usr/ucb/echo:
          not found</code>).
      </li>
      <li>
        Install SunStudio12: <code>pkg install -g
        http://pkg.openindiana.org/legacy sunstudio</code>
      </li>
      <li>
        Download mod_wsgi from <a href="http://code.google.com/p/modwsgi/">http://code.google.com/p/modwsgi/</a>.
      </li>
      <li>
        Compile and install: <code>./configure &amp;&amp; make &amp;&amp; make
        install</code>
      </li>
    </ul>

    <h4>MySQL</h4>
    <ul>
      <li>
        Install MySQL: <code>pkg install mysql-51</code>
      </li>
      <li>
        Enable MySQL server on startup: <code>svcadm enable mysql</code> (logs
        in <code>/var/mysql/data</code>).
      </li>
    </ul>

    <h3>Python 3</h3>
    <ul>
      <li>
        Get the latest version of Python 3 from <a href="http://www.python.org/download/">http://www.python.org/download/</a>.
      </li>
      <li>
        To build Python 3 you might need to install some extra packages:
        <code>pkg install gdbm</code>.  (Currently a bug in compiling the
        ncurses Python module on OpenIndiana, but this should not affect the
        functionality required for Numbas.)
      </li>
      <li>
        Unpack, change to the unpacked directory, then type <code>./configure
        --prefix=&lt;install_dir&gt;</code>
      </li>
      <li>
        If <code>configure</code> completes successfully, type
        <code>make</code>.  At this step, check to see whether there are
        reports of not being able to build certain Python modules (ignoring
        <code>_curses</code> and <code>_curses_panel</code>).  If there are,
        install the relevant packages, then recompile.
      </li>
      <li>
        Once <code>make</code> completes successfully, type <code>make
        install</code> to install Python 3 in your chosen install directory.
      </li>
    </ul>

    <h3>Python Pip, virtualenv and Django</h3>
    <p>
      The easiest way to install Django and related Python modules, without
      impacting on the system Python installation, is to use <a
        href="http://www.virtualenv.org">virtualenv</a>, which is a tool to
      create an isolated Python environment.
    </p>
    <ul>
      <li>
        Get the <code>virtualenv.py</code> script from the above URL.
      </li>
      <li>
        Type <code>python virtualenv.py &lt;dest_dir&gt;</code> to set up the
        isolated Python environment in <code>&lt;dest_dir&gt;</code>.
      </li>
      <li>
        Now 'activate' the environment with <code>.
          &lt;dest_dir&gt;/bin/activate</code> (this ensures that the Python
        libraries in the next step are installed in this environment, and not
        the system environment).
      </li>
      <li>
        Use the Python package installer (pip) to install Django and associated
        libraries: <code>pip install django django-taggit GitPython
        MySQL-python OrderedDict</code> (make sure the directory including
        the MySQL binaries is in the PATH, otherwise the MySQL-python install
        will fail).
      </li>
      <li>
        Update the library path: <code>crle -u -l
        /usr/mysql/5.1/lib/mysql</code>
      </li>
      <li>
        Bug in GitPython.  Change
        <code>&lt;dest_dir&gt;/lib/python2.6/site-packages/git/util.py</code>
        by adding <code>import pwd</code> to the top, and edit <code>def
          get_user_id()</code> replacing <code>username = os.getlogin()</code>
        with <code>username = pwd.getpwuid(os.getuid()).pw_name</code>
      </li>
    </ul>

    <h3>Other packages</h3>
    <ul>
      <li>
        <code>pkg install git</code>
      </li>
    </ul>

    <h2>Configuration</h2>
    <ul>
      <li>
        Create database <code>numbas_editor</code>
      </li>
      <li>
        Create database user and grant privileges on <code>numbas_editor</code>
        database:
        <ul>
          <li>
            <code>grant all privileges on numbas_editor.* to
            'numbas'@'localhost' identified by 'password';</code>
          </li>
        </ul>
      </li>
      <li>
        Create Numbas directories outside the webroot:
        <ul>
          <li><code>mkdir /srv/numbas</code></li>
          <li><code>mkdir /srv/numbas/dist</code></li>
          <li><code>mkdir /srv/numbas/previews</code></li>
          <li><code>mkdir /srv/numbas/questiondb</code></li>
        </ul>
      </li>
      <li>
        Set the correct ownership and permissions.  The following assumes that
        <code>/srv</code> and <code>/srv/www</code> are separate ZFS file
        systems, and that the ZFS properties <code>aclmode=passthrough</code>
        and <code>aclinherit=passthrough-x</code> are set on <code>/srv</code>.
        <ul>
          <li><code>chmod 770 previews questiondb</code></li>
          <li><code>chmod 750 dist</code></li>
          <li><code>chmod g+s dist previews questiondb</code></li>
          <li><code>chgrp webservd dist previews questiondb</code></li>
          <li><code>chmod A=owner@:full_set:fd:allow,group@:rwxpaRcs:fd:allow,everyone@:aRcs:fd:allow previews questiondb</code></li>
          <li><code>chmod A=owner@:full_set:fd:allow,group@:rxaRcs:fd:allow,everyone@:aRcs:fd:allow dist</code></li>
        </ul>
      </li>
      <li>
        Clone the Numbas repository: <code>git clone
        git://github.com/numbas/Numbas /srv/numbas/dist</code>
      </li>
      <li>
        Create the question/exam database:
        <ul>
          <li><code>cd /srv/numbas/questiondb</code></li>
          <li><code>mkdir exams questions</code></li>
          <li><code>git init</code></li>
        </ul>
      </li>
      <li>
        Create the editor directory and clone the editor under webroot:
        <ul>
          <li>
            <code>git clone git://github.com/numbas/editor
            /srv/www/numbas_editor</code>
          </li>
        </ul>
      </li>
      <li>
        Copy the editor distribution database and settings files:
        <ul>
          <li><code>cd /srv/www/numbas_editor</code></li>
          <li><code>cp database.py.dist database.py</code></li>
          <li><code>cp settings.py.dist settings.py</code></li>
        </ul>
      </li>
      <li>
        Edit <code>database.py</code>:
        <ul>
          <li>
            Set <code>ENGINE</code> to <code>django.db.backends.mysql</code>
          </li>
          <li>
            Set <code>NAME</code> to the database name
            (<code>numbas_editor</code>)
          </li>
          <li>
            Set <code>USER</code> to the database user (<code>numbas</code>)
          </li>
          <li>
            Set <code>PASSWORD</code> to the database password
            (<code>password</code>)
          </li>
        </ul>
      </li>
      <li>
        Edit <code>settings.py</code>:
        <ul>
          <li>
            Make sure settings in <code>GLOBAL_SETTINGS</code> match those
            above.
          </li>
          <li>
            <code>PREVIEW_URL</code> should be set to the URL at which preview
            exams can be viewed (see Apache 2 config file).
          </li>
          <li>
            <code>HELP_URL</code> should be set to the URL at which the Numbas
            web documentation can be viewed (see Apache 2 config file).
          </li>
          <li>
            <code>PYTHON_EXEC</code> is the path to the Python 3 executable
            (<code>&lt;install_dir&gt;/bin/python3</code>).
          </li>
        </ul>
      </li>
      <li>
        Copy <code>editor/templates/index.html.dist</code> to
        <code>editor/templates/index.html</code> and customise.
      </li>
      <li>
        Copy <code>web/django.wsgi.dist</code> to <code>web/django.wsgi</code>
        and edit:
        <ul>
          <li>
            Make sure the two <code>sys.path.append</code> lines match the
            paths on the file system.
          </li>
          <li>
            <code>DJANGO_SETTINGS_MODULE</code> should be set to
            <code>numbas_editor.settings</code> (if following above naming
            scheme).
          </li>
          <li>
            Uncomment the two lines needed to add an additional Python site
            directory.  Edit the path to the virtualenv as necessary.
          </li>
        </ul>
      </li>
      <li>
        Sync the database:
        <ul>
          <li><code>python manage.py syncdb</code></li>
          <li>Create a superuser (answer <code>yes</code>).</li>
          <li>Enter username, e-mail address, and password.</li>
        </ul>
      </li>
      <li>
        Create apache config file
        <code>/etc/httpd/conf.d/numbas-editor.conf</code>.
        <ul>
          <li>
            Edit the config file with contents similar to that in <a
              href="apache2_openindiana.conf"><code>apache2_openindiana.conf</code></a>.
            If following these instructions exactly, then all that needs
            changing are the lines <code>ServerName</code>,
            <code>ServerAdmin</code>, <code>WSGIDaemonProcess</code>,
            <code>WSGIProcessGroup</code>, and the two lines for the static
            admin pages (set the path to the virtualenv correctly).
          </li>
        </ul>
      </li>
      <li>
        Restart the web server, then point your browser at the server hostname.
      </li>
    </ul>

    <h2>LDAP authentication</h2>
    <p>
    	LDAP authentication is possible within the editor.  This can work in
    	combination with the default Django Model authentication backend.
    </p>
    
    <h3>Extra required packages</h3>
    <p>
      For LDAP to work you need the Python LDAP module
      (<code>python-ldap</code>), and the Django LDAP authentication module
      (<code>django-auth-ldap</code>).
    </p>

    <p>
      As of writing, the Python LDAP module must be compiled against OpenLDAP
      2.4 or above.  The native OpenIndiana Apache 2 packages have been built
      with the Sun LDAP SDK, however.  This mismatch causes Apache to crash
      with a segmentation fault when any LDAP calls are made.
    </p>

    <p>
      The only workaround for this would be to build Apache 2 from source, and
      link against OpenLDAP.
    </p>

    <!--
	  <ul>
      <li><code>pkg install openldap</code></li>
    </ul>

    <h4>Django LDAP</h4>
    <ul>
		  <li>(From within the virtualenv): <code>pip install django-auth-ldap</code></li>
    </ul>
    <p>
      If the above fails, it is probably a consequence of the dependency
      <code>python-ldap</code>, which is compiled first.  The build script
      looks in the wrong place for LDAP header files and libraries.  Follow
      these steps to correct the problem.
    </p>

    <ul>
      <li>Change to the build directory for <code>python-ldap</code>, e.g.
        <code>/path/to/virtualenv/build/python-ldap</code>.</li>
      <li>Edit <code>setup.cfg</code> and change <code>include_dirs</code> so
        that it includes <code>/usr/include/openldap</code>.  Also change
        <code>libs</code> to <code>libs = ldap_r-2.4</code>.</li>
      <li>Type <code>python setup.py build</code>, then <code>python setup.py
        install</code>.</li>
      <li>Change out of that directory, then run <code>pip install
        django-auth-ldap</code> again.</li>
    </ul>
    -->
	
    <h3>Extra configuration</h3>
    <p>
      Assuming the library problem above is resolved, then the following extra
      configuration should allow you to use LDAP authentication.
    </p>

    <ul>
    	<li>Copy <code>ldap_auth.py.dist</code> to <code>ldap_auth.py</code>
    		and edit, following the comments in that file.</li>
		<li>In <code>settings.py</code> uncomment the LDAP auth line in
			<code>AUTHENTICATION_BACKENDS</code> and the <code>ldap_auth</code>
			import line.</li>
    </ul>
    
    <p>
      <b>Note that if any changes are made to the editor code, including
        editing the settings files, then for the web server to recognise these
        changes either touch the <code>web/django.wsgi</code> file, or restart
        the Apache server.</b>
    </p>
  </body>
</html>
